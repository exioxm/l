<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dispatch: CHP - Los Angeles</title>
    <style>
        :root { --chp-yellow: #F7B500; --bright-yellow: #FFFF00; --chp-blue: #003da7; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Arial Black', sans-serif; background: var(--chp-yellow); }
        #menu { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; background: var(--chp-yellow); }
        #title { font-size: 60px; color: var(--bright-yellow); -webkit-text-stroke: 3px black; text-shadow: 4px 4px 0px #000; margin-bottom: 20px; }
        .btn { padding: 15px 40px; font-size: 22px; background: var(--bright-yellow); border: 5px solid black; cursor: pointer; font-weight: bold; }
        #game-ui { display: none; width: 100%; height: 100%; position: relative; }
        canvas { background: #222; cursor: crosshair; }
        .context-menu { position: absolute; display: none; background: rgba(0,0,0,0.95); border: 2px solid var(--chp-yellow); padding: 10px; border-radius: 4px; z-index: 500; color: white; width: 180px; }
        .dispatch-btn { width: 100%; padding: 10px; margin: 4px 0; border: none; cursor: pointer; font-weight: bold; font-size: 11px; }
        .near-btn { background: #2E7D32; color: white; }
        .all-btn { background: #C62828; color: white; }
        #fleet-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 100px; background: var(--chp-yellow); border-top: 5px solid black; display: flex; align-items: center; padding: 0 20px; gap: 15px; overflow-x: auto; box-sizing: border-box; }
        .fleet-unit { background: white; border: 2px solid black; padding: 5px 10px; min-width: 130px; font-size: 11px; display: flex; flex-direction: column; color: black; }
        #shop-sidebar { position: absolute; right: 0; top: 0; width: 220px; height: calc(100% - 100px); background: rgba(0,0,0,0.9); border-left: 5px solid var(--chp-blue); color: white; padding: 15px; z-index: 90; box-sizing: border-box; }
        .shop-card { background: #222; border: 1px solid #444; padding: 8px; margin-bottom: 12px; }
        .buy-btn { background: var(--chp-yellow); color: black; border: none; width: 100%; padding: 5px; cursor: pointer; font-weight: bold; }
        #stats { position: absolute; left: 20px; top: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-left: 5px solid var(--chp-yellow); z-index: 80; }
    </style>
</head>
<body>

<div id="menu">
    <div id="title">Dispatch: CHP</div>
    <button class="btn" onclick="initGame()">Start game</button>
</div>

<div id="dispatch-menu" class="context-menu">
    <div id="crime-label" style="font-weight:bold; margin-bottom:5px; text-align:center;">CRIME</div>
    <button class="dispatch-btn near-btn" onclick="dispatchNearest()">SEND NEAREST</button>
    <button class="dispatch-btn all-btn" onclick="dispatchAll()">SEND ALL UNITS</button>
</div>

<div id="game-ui">
    <canvas id="gameCanvas"></canvas>
    <div id="stats">CASH: <span id="money" style="color:var(--bright-yellow);">$2000</span></div>
    <div id="shop-sidebar">
        <h3 style="color:var(--chp-yellow);">CHP FLEET</h3>
        <div class="shop-card">Crown Vic ($500) <button class="buy-btn" onclick="buyVehicle('CrownVic')">BUY</button></div>
        <div class="shop-card">Explorer ($800) <button class="buy-btn" onclick="buyVehicle('Explorer')">BUY</button></div>
    </div>
    <div id="fleet-bar"></div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const dMenu = document.getElementById('dispatch-menu');
let money = 2000, units = [], crimes = [], lights = [], selectedCrime = null;
const roadSize = 120, buildingSize = 80;

const vehicleData = {
    'CrownVic': { speed: 2.2, color: '#f0f0f0', cost: 500, pwr: 1 },
    'Explorer': { speed: 2.5, color: '#111', cost: 800, pwr: 1.5 }
};

function initGame() {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('game-ui').style.display = 'block';
    canvas.width = window.innerWidth - 220;
    canvas.height = window.innerHeight - 100;
    
    // Create Traffic Lights at every intersection
    for(let x=roadSize; x<canvas.width; x+=roadSize) {
        for(let y=roadSize; y<canvas.height; y+=roadSize) {
            lights.push({ x, y, state: 'green', timer: Math.random() * 5000 });
        }
    }
    
    spawnUnit('CrownVic'); spawnUnit('Explorer');
    requestAnimationFrame(gameLoop);
    setInterval(spawnCrime, 8000);
}

function spawnUnit(type) {
    units.push({ 
        type, x: 60, y: 60, tx: 60, ty: 60, status: 'IDLE', 
        patrolTarget: null, ...vehicleData[type], targetCrime: null 
    });
    updateUI();
}

function buyVehicle(type) { 
    if(money >= vehicleData[type].cost) { money -= vehicleData[type].cost; spawnUnit(type); updateUI(); } 
}

function spawnCrime() {
    const types = [{name: 'Bank Robbery', req: 3, reward: 2000, color: 'red'}];
    const c = types[0];
    let rx = Math.floor(Math.random() * (canvas.width/roadSize)) * roadSize + 60;
    let ry = Math.floor(Math.random() * (canvas.height/roadSize)) * roadSize + 60;
    crimes.push({ ...c, x: rx, y: ry, progress: 100 });
}

function dispatchNearest() {
    if(!selectedCrime) return;
    let nearest = null, minDist = Infinity;
    units.forEach(u => {
        const d = Math.sqrt((u.x-selectedCrime.x)**2 + (u.y-selectedCrime.y)**2);
        if(d < minDist) { minDist = d; nearest = u; }
    });
    if(nearest) { nearest.status = 'ENROUTE'; nearest.targetCrime = selectedCrime; }
    dMenu.style.display = 'none';
}

function dispatchAll() {
    units.forEach(u => { u.status = 'ENROUTE'; u.targetCrime = selectedCrime; });
    dMenu.style.display = 'none';
}

function getPatrolPoint() {
    let rx = Math.floor(Math.random() * (canvas.width/roadSize)) * roadSize + 60;
    let ry = Math.floor(Math.random() * (canvas.height/roadSize)) * roadSize + 60;
    return {x: rx, y: ry};
}

function gameLoop() {
    ctx.fillStyle = "#111"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw Roads & Lanes
    ctx.strokeStyle = "#444";
    for(let x=0; x<canvas.width; x+=roadSize) {
        for(let y=0; y<canvas.height; y+=roadSize) {
            ctx.fillStyle = "#222"; ctx.fillRect(x, y, roadSize, roadSize);
            ctx.setLineDash([10, 10]); ctx.strokeStyle = "#F7B500";
            ctx.beginPath(); ctx.moveTo(x + 60, y); ctx.lineTo(x + 60, y + roadSize); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(x, y + 60); ctx.lineTo(x + roadSize, y + 60); ctx.stroke();
        }
    }

    // Draw Buildings
    ctx.fillStyle = "#0a0a0a";
    for(let x=10; x<canvas.width; x+=roadSize) {
        for(let y=10; y<canvas.height; y+=roadSize) {
            ctx.fillRect(x, y, 100, 100);
        }
    }

    // Traffic Lights Logic
    lights.forEach(l => {
        l.timer += 16;
        if(l.timer > 5000) { l.state = (l.state === 'green' ? 'red' : 'green'); l.timer = 0; }
        ctx.fillStyle = l.state; ctx.beginPath(); ctx.arc(l.x, l.y, 8, 0, Math.PI*2); ctx.fill();
    });

    // Crimes
    crimes.forEach((c, i) => {
        ctx.fillStyle = c.color; ctx.beginPath(); ctx.arc(c.x, c.y, 15, 0, Math.PI*2); ctx.fill();
        const onsite = units.filter(u => u.targetCrime === c && u.status === 'ON_SCENE');
        if(onsite.length >= c.req) {
            c.progress -= 0.2;
            if(c.progress <= 0) { money += c.reward; units.filter(u => u.targetCrime === c).forEach(u => u.status = 'IDLE'); crimes.splice(i, 1); updateUI(); }
        }
    });

    // Units Logic (Patrol + Dispatch)
    units.forEach(u => {
        let currentTarget = u.status === 'ENROUTE' ? u.targetCrime : u.patrolTarget;
        if(!currentTarget && u.status === 'IDLE') u.patrolTarget = getPatrolPoint();
        
        if(currentTarget) {
            let dx = currentTarget.x - u.x, dy = currentTarget.y - u.y, d = Math.sqrt(dx*dx+dy*dy);
            
            // Traffic Light Collision
            let stopped = false;
            if(u.status === 'IDLE') {
                lights.forEach(l => {
                    let ld = Math.sqrt((u.x-l.x)**2 + (u.y-l.y)**2);
                    if(ld < 40 && l.state === 'red') stopped = true;
                });
            }

            if(d > 5 && !stopped) {
                u.x += (dx/d)*u.speed; u.y += (dy/d)*u.speed;
            } else if (d <= 5) {
                if(u.status === 'ENROUTE') u.status = 'ON_SCENE';
                else u.patrolTarget = getPatrolPoint();
            }
        }
        
        // Render Car
        ctx.fillStyle = u.color; ctx.fillRect(u.x-10, u.y-6, 20, 12);
        if(u.status === 'ENROUTE') { 
            ctx.fillStyle = (Date.now()%200<100)?'red':'blue'; ctx.fillRect(u.x-10, u.y-9, 20, 3); 
        }
    });

    requestAnimationFrame(gameLoop);
}

canvas.addEventListener('mousedown', (e) => {
    crimes.forEach(c => {
        if(Math.sqrt((e.offsetX-c.x)**2 + (e.offsetY-c.y)**2) < 30) {
            selectedCrime = c; dMenu.style.display = 'block';
            dMenu.style.left = e.clientX+'px'; dMenu.style.top = e.clientY+'px';
        }
    });
});

function updateUI() {
    document.getElementById('money').innerText = `$${money}`;
    const bar = document.getElementById('fleet-bar');
    bar.innerHTML = units.map(u => `<div class="fleet-unit"><strong>${u.type}</strong><span>[${u.status}]</span></div>`).join('');
}
</script>
</body>
</html>

) to find a direct URL.
siren.src = "https://cdn.pixabay.com"; 
siren.loop = true;

function initGame() {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('game-ui').style.display = 'block';
    canvas.width = window.innerWidth - 250;
    canvas.height = window.innerHeight;
    spawnUnit('CrownVic', 150, 150);
    spawnUnit('CrownVic', 170, 150);
    spawnUnit('Explorer', 160, 170);
    requestAnimationFrame(gameLoop);
    setInterval(spawnCrime, 6000);
}

function spawnUnit(type, x, y) {
    units.push({ type, x, y, tx: x, ty: y, status: 'IDLE', speed: vehicleData[type].speed, targetCrime: null });
    document.getElementById('unit-count').innerText = units.length;
}

function buyVehicle(type) {
    if(money >= vehicleData[type].cost) {
        money -= vehicleData[type].cost;
        spawnUnit(type, 150, 150);
        document.getElementById('money').innerText = `$${money}`;
    }
}

function spawnCrime() {
    const types = [
        { name: 'Bank Robbery', req: 3, reward: 1200, color: '#FF0000', moving: false },
        { name: 'Store Robbery', req: 1, reward: 400, color: '#FFA500', moving: false },
        { name: 'Reckless Driver', req: 1, reward: 600, color: '#A020F0', moving: true }
    ];
    const c = types[Math.floor(Math.random() * types.length)];
    const newCrime = { ...c, x: Math.random()*(canvas.width-200)+100, y: Math.random()*(canvas.height-200)+100, progress: 100, unitsOnScene: 0 };
    crimes.push(newCrime);
    lastCrime = newCrime;
}

function dispatchUnits(crime, all = false) {
    if (!crime) return;
    let dispatchedCount = 0;
    units.forEach(u => {
        if(u.status === 'IDLE' || (all && u.targetCrime !== crime)) {
            u.status = 'ENROUTE';
            u.tx = crime.x; u.ty = crime.y;
            u.targetCrime = crime;
            dispatchedCount++;
            if(!all && dispatchedCount >= 1) return; 
        }
    });
    if (dispatchedCount > 0 && siren.paused) siren.play().catch(()=>{});
}

// Spacebar Listener
window.addEventListener('keydown', (e) => {
    if(e.code === 'Space') {
        e.preventDefault();
        dispatchUnits(lastCrime, true);
    }
});

function gameLoop() {
    ctx.fillStyle = "#1a1a1a"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw Downtown LA Skyscrapers
    ctx.fillStyle = "#333";
    for(let i=0; i<canvas.width; i+=gridSize*1.5) {
        for(let j=0; j<canvas.height; j+=gridSize*1.5) {
            ctx.fillRect(i+30, j+30, 80, 80);
            ctx.strokeStyle = "#4a4a4a"; ctx.strokeRect(i+30, j+30, 80, 80);
        }
    }

    // Update Crimes
    crimes.forEach((c, i) => {
        c.unitsOnScene = units.filter(u => u.targetCrime === c && u.status === 'ON_SCENE').length;
        if(c.unitsOnScene >= c.req) {
            c.progress -= (0.05 * c.unitsOnScene);
            if(c.progress <= 0) {
                money += c.reward; document.getElementById('money').innerText = `$${money}`;
                units.filter(u => u.targetCrime === c).forEach(u => { u.status = 'IDLE'; u.targetCrime = null; });
                crimes.splice(i, 1);
                if(units.every(u => u.status === 'IDLE')) siren.pause();
                return;
            }
        }
        if(c.moving) { c.x += Math.sin(Date.now()/800); c.y += Math.cos(Date.now()/800); }
        ctx.fillStyle = c.color; ctx.beginPath(); ctx.arc(c.x, c.y, 18, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "white"; ctx.fillText(c.name + ` (${Math.ceil(c.progress)}%)`, c.x-30, c.y-25);
    });

    // Update Units
    units.forEach(u => {
        if(u.status === 'ENROUTE') {
            if(u.targetCrime) { u.tx = u.targetCrime.x; u.ty = u.targetCrime.y; }
            let dx = u.tx - u.x, dy = u.ty - u.y, dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 5) { u.x += (dx/dist)*u.speed; u.y += (dy/dist)*u.speed; }
            else u.status = 'ON_SCENE';
        }
        ctx.fillStyle = vehicleData[u.type].color; ctx.fillRect(u.x-6, u.y-6, 12, 12);
        if(u.status === 'ENROUTE') {
            ctx.fillStyle = (Date.now()%300<150) ? 'red' : 'blue'; ctx.fillRect(u.x-6, u.y-10, 12, 4);
        }
    });
    requestAnimationFrame(gameLoop);
}

canvas.addEventListener('mousedown', (e) => {
    crimes.forEach(c => {
        if(Math.sqrt((e.offsetX-c.x)**2 + (e.offsetY-c.y)**2) < 40) dispatchUnits(c, false);
    });
});
</script>
</body>
</html>

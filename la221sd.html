<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dispatch: CHP - Los Angeles</title>
    <style>
        :root { --chp-yellow: #F7B500; --bright-yellow: #FFFF00; --chp-blue: #003da7; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Arial Black', sans-serif; background: var(--chp-yellow); }
        
        #menu { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; background: var(--chp-yellow); }
        #title { font-size: 80px; color: var(--bright-yellow); -webkit-text-stroke: 3px black; text-shadow: 4px 4px 0px #000; margin-bottom: 30px; }
        .btn { padding: 20px 50px; font-size: 24px; background: var(--bright-yellow); border: 5px solid black; cursor: pointer; font-weight: bold; }

        #game-ui { display: none; width: 100%; height: 100%; position: relative; }
        canvas { background: #1a1a1a; cursor: crosshair; }
        
        /* Dispatch Context Menu */
        #dispatch-menu { 
            position: absolute; display: none; background: rgba(0,0,0,0.9); 
            border: 2px solid var(--chp-yellow); padding: 10px; border-radius: 8px; z-index: 50;
            color: white; font-family: sans-serif; width: 160px;
        }
        .dispatch-btn { 
            width: 100%; padding: 8px; margin: 4px 0; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; font-size: 11px;
        }
        .near-btn { background: #4CAF50; color: white; }
        .all-btn { background: #f44336; color: white; }

        #sidebar { position: absolute; right: 0; top: 0; width: 240px; height: 100%; background: rgba(0,0,0,0.9); color: white; padding: 15px; border-left: 4px solid var(--chp-blue); overflow-y: auto; }
        #station-stats { position: absolute; left: 20px; bottom: 20px; background: rgba(255,255,255,0.9); border: 3px solid var(--chp-blue); padding: 10px; border-radius: 8px; font-size: 14px; }
    </style>
</head>
<body>

<div id="menu">
    <div id="title">Dispatch: CHP</div>
    <button class="btn" onclick="initGame()">Start game</button>
</div>

<!-- Right-click or Left-click UI Menu for Crimes -->
<div id="dispatch-menu">
    <div id="crime-name-label" style="font-weight:bold; margin-bottom:5px; text-align:center;">CRIME</div>
    <button class="dispatch-btn near-btn" onclick="dispatchNearest()">SEND NEAREST</button>
    <button class="dispatch-btn all-btn" onclick="dispatchAll()">SEND ALL UNITS</button>
</div>

<div id="game-ui">
    <canvas id="gameCanvas"></canvas>
    
    <div id="station-stats">
        <strong>OPERATIONS HUB</strong><br>
        Cash: <span id="money" style="color:green;">$500</span><br>
        Units: <span id="unit-count">3</span>
    </div>

    <div id="sidebar">
        <h3 style="color:var(--chp-yellow); font-size:16px;">PURCHASE FLEET</h3>
        <div style="background:#222; padding:10px; margin-bottom:8px; font-size:12px;">
            Crown Vic ($500) <button onclick="buyVehicle('CrownVic')" style="float:right;">BUY</button><br>
            Explorer ($800) <button onclick="buyVehicle('Explorer')" style="float:right;">BUY</button><br>
            Charger ($1200) <button onclick="buyVehicle('Charger')" style="float:right;">BUY</button><br>
            Tahoe ($1500) <button onclick="buyVehicle('Tahoe')" style="float:right;">BUY</button><br>
            Durango ($2000) <button onclick="buyVehicle('Durango')" style="float:right;">BUY</button>
        </div>
        <p style="font-size:10px; color:#888;">*Click a crime icon to open dispatch menu</p>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const dMenu = document.getElementById('dispatch-menu');
let money = 500, units = [], crimes = [], selectedCrime = null;
const gridSize = 100;

// Station Building Data (Top Center)
const stationPos = { x: 0, y: 0, w: 180, h: 100 };

const vehicleData = {
    'CrownVic': { speed: 2.2, color: 'white', cost: 500 },
    'Explorer': { speed: 2.6, color: 'black', cost: 800 },
    'Charger': { speed: 3.8, color: 'white', cost: 1200 },
    'Tahoe': { speed: 2.4, color: 'black', cost: 1500 },
    'Durango': { speed: 4.2, color: 'darkgray', cost: 2000 }
};

function initGame() {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('game-ui').style.display = 'block';
    canvas.width = window.innerWidth - 240;
    canvas.height = window.innerHeight;
    stationPos.x = (canvas.width / 2) - (stationPos.w / 2);
    
    // Starting Units
    for(let i=0; i<2; i++) spawnUnit('CrownVic');
    spawnUnit('Explorer');
    
    requestAnimationFrame(gameLoop);
    setInterval(spawnCrime, 7000);
}

function spawnUnit(type) {
    units.push({ 
        type, 
        x: stationPos.x + 40 + (Math.random()*100), 
        y: stationPos.y + 110, 
        tx: 0, ty: 0, 
        status: 'IDLE', 
        speed: vehicleData[type].speed, 
        targetCrime: null 
    });
    document.getElementById('unit-count').innerText = units.length;
}

function buyVehicle(type) {
    if(money >= vehicleData[type].cost) {
        money -= vehicleData[type].cost;
        spawnUnit(type);
        updateUI();
    }
}

function spawnCrime() {
    const types = [
        { name: 'Bank Robbery', req: 3, reward: 1500, color: 'red', moving: false },
        { name: 'Store Robbery', req: 1, reward: 400, color: 'orange', moving: false },
        { name: 'Reckless Driver', req: 1, reward: 700, color: 'magenta', moving: true }
    ];
    const c = types[Math.floor(Math.random() * types.length)];
    crimes.push({ 
        ...c, 
        x: Math.random()*(canvas.width-200)+100, 
        y: Math.random()*(canvas.height-300)+200, 
        progress: 100 
    });
}

function dispatchNearest() {
    if(!selectedCrime) return;
    let nearest = null;
    let minDist = Infinity;
    units.forEach(u => {
        if(u.status === 'IDLE') {
            const dist = Math.sqrt((u.x-selectedCrime.x)**2 + (u.y-selectedCrime.y)**2);
            if(dist < minDist) { minDist = dist; nearest = u; }
        }
    });
    if(nearest) {
        nearest.status = 'ENROUTE';
        nearest.targetCrime = selectedCrime;
    }
    dMenu.style.display = 'none';
}

function dispatchAll() {
    if(!selectedCrime) return;
    units.forEach(u => {
        if(u.status === 'IDLE' || u.targetCrime !== selectedCrime) {
            u.status = 'ENROUTE';
            u.targetCrime = selectedCrime;
        }
    });
    dMenu.style.display = 'none';
}

function gameLoop() {
    ctx.fillStyle = "#1a1a1a"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw Downtown Grid (Skyscrapers)
    ctx.fillStyle = "#2a2a2a";
    for(let i=0; i<canvas.width; i+=gridSize*1.5) {
        for(let j=150; j<canvas.height; j+=gridSize*1.5) {
            ctx.fillRect(i+20, j+20, 70, 70);
            ctx.strokeStyle = "#444"; ctx.strokeRect(i+20, j+20, 70, 70);
        }
    }

    // DRAW THE CHP STATION BUILDING (Detailed)
    ctx.fillStyle = "#555"; // Main building body
    ctx.fillRect(stationPos.x, stationPos.y, stationPos.w, stationPos.h);
    ctx.fillStyle = "#333"; // Roof detail
    ctx.fillRect(stationPos.x + 10, stationPos.y + 10, stationPos.w - 20, stationPos.h - 20);
    ctx.fillStyle = "var(--chp-blue)"; // Blue line accent
    ctx.fillRect(stationPos.x, stationPos.y + 30, stationPos.w, 10);
    ctx.fillStyle = "white"; ctx.font = "10px sans-serif";
    ctx.fillText("CHP CENTRAL HQ", stationPos.x + 45, stationPos.y + 25);
    // Radio Tower
    ctx.strokeStyle = "gray"; ctx.beginPath(); ctx.moveTo(stationPos.x + 20, stationPos.y); ctx.lineTo(stationPos.x + 20, stationPos.y - 40); ctx.stroke();

    // Crimes
    crimes.forEach((c, i) => {
        const activeOnScene = units.filter(u => u.targetCrime === c && u.status === 'ON_SCENE').length;
        if(activeOnScene >= c.req) {
            c.progress -= (0.1 * activeOnScene);
            if(c.progress <= 0) {
                money += c.reward; updateUI();
                units.filter(u => u.targetCrime === c).forEach(u => { u.status = 'IDLE'; u.targetCrime = null; });
                crimes.splice(i, 1); return;
            }
        }
        if(c.moving) { c.x += Math.sin(Date.now()/1000); c.y += Math.cos(Date.now()/1000); }
        ctx.fillStyle = c.color; ctx.beginPath(); ctx.arc(c.x, c.y, 15, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "white"; ctx.fillText(`${c.name} (${Math.ceil(c.progress)}%)`, c.x - 40, c.y - 20);
    });

    // Units
    units.forEach(u => {
        if(u.status === 'ENROUTE' && u.targetCrime) {
            let dx = u.targetCrime.x - u.x, dy = u.targetCrime.y - u.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 5) { u.x += (dx/dist)*u.speed; u.y += (dy/dist)*u.speed; }
            else u.status = 'ON_SCENE';
        } else if (u.status === 'IDLE') {
            // Return to station
            let dx = (stationPos.x + 50) - u.x, dy = (stationPos.y + 110) - u.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 5) { u.x += (dx/dist)*u.speed; u.y += (dy/dist)*u.speed; }
        }
        ctx.fillStyle = vehicleData[u.type].color; ctx.fillRect(u.x-5, u.y-5, 10, 10);
        if(u.status === 'ENROUTE') {
            ctx.fillStyle = (Date.now()%400<200)?'red':'blue'; ctx.fillRect(u.x-5, u.y-8, 10, 3);
        }
    });
    requestAnimationFrame(gameLoop);
}

canvas.addEventListener('mousedown', (e) => {
    let found = false;
    crimes.forEach(c => {
        const dist = Math.sqrt((e.offsetX-c.x)**2 + (e.offsetY-c.y)**2);
        if(dist < 30) {
            selectedCrime = c;
            dMenu.style.display = 'block';
            dMenu.style.left = e.clientX + 'px';
            dMenu.style.top = (e.clientY - 80) + 'px';
            document.getElementById('crime-name-label').innerText = c.name;
            found = true;
        }
    });
    if(!found) dMenu.style.display = 'none';
});

function updateUI() {
    document.getElementById('money').innerText = `$${money}`;
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dispatch: CHP - Los Angeles District</title>
    <style>
        :root { --chp-yellow: #F7B500; --bright-yellow: #FFFF00; --chp-blue: #003da7; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Arial Black', sans-serif; background: var(--chp-yellow); }
        
        #menu { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; background: var(--chp-yellow); }
        #title { font-size: 70px; color: var(--bright-yellow); -webkit-text-stroke: 3px black; text-shadow: 4px 4px 0px #000; margin-bottom: 20px; text-align: center; }
        .btn { padding: 20px 50px; font-size: 24px; background: var(--bright-yellow); border: 5px solid black; cursor: pointer; font-weight: bold; }

        #game-ui { display: none; width: 100%; height: 100%; position: relative; }
        canvas { background: #111; cursor: crosshair; }
        
        .context-menu { 
            position: absolute; display: none; background: rgba(0,0,0,0.95); 
            border: 2px solid var(--chp-yellow); padding: 10px; border-radius: 4px; z-index: 500;
            color: white; font-family: sans-serif; width: 180px; box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .dispatch-btn { width: 100%; padding: 10px; margin: 4px 0; border: none; cursor: pointer; font-weight: bold; font-size: 12px; border-radius: 2px; }

        #fleet-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100px;
            background: var(--chp-yellow); border-top: 5px solid black;
            display: flex; align-items: center; padding: 0 20px; box-sizing: border-box;
            overflow-x: auto; gap: 15px; z-index: 100;
        }
        .fleet-unit { background: white; border: 2px solid black; padding: 5px 10px; height: 75px; min-width: 150px; font-size: 10px; display: flex; flex-direction: column; justify-content: center; color: black; }

        #shop-sidebar { 
            position: absolute; right: 0; top: 0; width: 230px; height: calc(100% - 100px); 
            background: rgba(0,0,0,0.9); border-left: 5px solid var(--chp-blue); color: white;
            padding: 15px; overflow-y: auto; z-index: 90; box-sizing: border-box;
        }
        .shop-card { background: #222; border: 1px solid #444; padding: 8px; margin-bottom: 12px; border-radius: 4px; }
        .buy-btn { background: var(--chp-yellow); color: black; border: none; width: 100%; padding: 6px; cursor: pointer; font-weight: bold; }

        #station-stats { position: absolute; left: 20px; top: 20px; background: rgba(0,0,0,0.7); color: white; border-left: 5px solid var(--chp-yellow); padding: 10px; z-index: 80; font-size: 14px; }
        #weather-info { color: #88ccff; font-style: italic; }
    </style>
</head>
<body>

<div id="menu">
    <div id="title">Dispatch: CHP</div>
    <button class="btn" onclick="initGame()">Start game</button>
</div>

<div id="dispatch-menu" class="context-menu">
    <div id="crime-name-label" style="font-weight:bold; margin-bottom:5px; text-align:center; color: var(--chp-yellow);">CRIME REPORTED</div>
    <button class="dispatch-btn" style="background:#2E7D32; color:white;" onclick="dispatchNearest()">SEND NEAREST</button>
    <button class="dispatch-btn" style="background:#C62828; color:white;" onclick="dispatchAll()">SEND ALL UNITS</button>
</div>

<div id="game-ui">
    <canvas id="gameCanvas"></canvas>
    
    <div id="station-stats">
        <strong>OPERATIONS HUB</strong><br>
        CASH: <span id="money" style="color:var(--bright-yellow); font-weight:bold;">$3000</span><br>
        WANTED LEVEL: <span id="wanted-level">☆☆☆☆☆</span><br>
        WEATHER: <span id="weather-info">Clear</span>
    </div>

    <div id="shop-sidebar">
        <h3 style="color:var(--chp-yellow); margin-top:0;">PURCHASE</h3>
        <div class="shop-card">Crown Vic ($500) <button class="buy-btn" onclick="buyVehicle('CrownVic')">BUY</button></div>
        <div class="shop-card">Explorer ($800) <button class="buy-btn" onclick="buyVehicle('Explorer')">BUY</button></div>
    </div>

    <div id="fleet-bar"></div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const dMenu = document.getElementById('dispatch-menu');
let money = 3000, units = [], crimes = [], lights = [], peds = [], mapBuildings = [];
let raindrops = [], isRaining = false, weatherTimer = 0;
let selectedCrime = null, wantedLevel = 0;
const roadSize = 160;

const vehicleData = {
    'CrownVic': { speed: 2.5, color: '#f0f0f0', cost: 500, pwr: 1 },
    'Explorer': { speed: 2.2, color: '#111', cost: 800, pwr: 1.5 }
};

function initGame() {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('game-ui').style.display = 'block';
    canvas.width = window.innerWidth - 230;
    canvas.height = window.innerHeight - 100;
    
    mapBuildings = [
        { x: 180, y: 180, w: 120, h: 120, name: "Apartments", color: "#555" },
        { x: 340, y: 180, w: 120, h: 120, name: "Supermarket", color: "#4CAF50" },
        { x: 180, y: 340, w: 280, h: 120, name: "City Park", color: "#2E7D32" }
    ];

    for(let x=roadSize; x<canvas.width; x+=roadSize) {
        for(let y=roadSize; y<canvas.height; y+=roadSize) {
            lights.push({ x, y, state: 'green', timer: Math.random() * 4000 });
        }
    }
    
    for(let i=0; i<10; i++) spawnPed();
    spawnUnit('CrownVic'); spawnUnit('Explorer');
    
    requestAnimationFrame(gameLoop);
    setInterval(spawnCrime, 9000);
    setInterval(toggleWeather, 20000); // Random weather check every 20s
}

function toggleWeather() {
    isRaining = Math.random() > 0.6;
    document.getElementById('weather-info').innerText = isRaining ? "Heavy Rain" : "Clear";
    if(isRaining) { raindrops = Array.from({length: 100}, () => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: 5+Math.random()*10})); }
}

function spawnPed() {
    peds.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: 0.4+Math.random()*0.4, tx: Math.random()*canvas.width, ty: Math.random()*canvas.height, c: '#fff' });
}

function spawnUnit(type) {
    units.push({ 
        type, x: 40, y: 40, status: 'IDLE', patrolDir: 'x', 
        level: 1, xp: 0, 
        baseSpeed: vehicleData[type].speed, 
        basePwr: vehicleData[type].pwr,
        ...vehicleData[type], targetCrime: null, id: Math.random() 
    });
    updateUI();
}

function buyVehicle(type) { if(money >= vehicleData[type].cost) { money -= vehicleData[type].cost; spawnUnit(type); updateUI(); } }

function spawnCrime() {
    let rx = Math.floor(Math.random()*(canvas.width/roadSize))*roadSize + 80;
    let ry = Math.floor(Math.random()*(canvas.height/roadSize))*roadSize + 80;
    crimes.push({ name: 'Robbery', x: rx, y: ry, progress: 100 + (wantedLevel*40), color: 'red' });
    if(crimes.length > 3) wantedLevel = Math.min(5, wantedLevel + 0.4);
    updateUI();
}

function dispatchNearest() {
    if(selectedCrime) {
        let nearest = units.filter(u => u.status === 'IDLE').sort((a,b) => 
            Math.sqrt((a.x-selectedCrime.x)**2+(a.y-selectedCrime.y)**2) - 
            Math.sqrt((b.x-selectedCrime.x)**2+(b.y-selectedCrime.y)**2)
        )[0];
        if(nearest) { nearest.status = 'ENROUTE'; nearest.targetCrime = selectedCrime; }
    }
    dMenu.style.display = 'none';
}

function dispatchAll() { units.forEach(u => { u.status = 'ENROUTE'; u.targetCrime = selectedCrime; }); dMenu.style.display = 'none'; }

function gameLoop() {
    ctx.fillStyle = isRaining ? "#0a0a12" : "#1a1a1a"; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Roads
    for(let x=0; x<canvas.width; x+=roadSize) {
        for(let y=0; y<canvas.height; y+=roadSize) {
            ctx.fillStyle = "#222"; ctx.fillRect(x, 0, 80, canvas.height); ctx.fillRect(0, y, canvas.width, 80);
            ctx.fillStyle = "rgba(255,255,255,0.1)"; ctx.fillRect(x+20, y-10, 40, 20); ctx.fillRect(x-10, y+20, 20, 40);
        }
    }

    mapBuildings.forEach(b => { ctx.fillStyle = b.color; ctx.fillRect(b.x, b.y, b.w, b.h); ctx.fillStyle = "white"; ctx.font = "10px Arial"; ctx.fillText(b.name, b.x+5, b.y+15); });

    lights.forEach(l => {
        l.timer += 16; if(l.timer > 4000) { l.state = (l.state === 'green' ? 'red' : 'green'); l.timer = 0; }
        ctx.fillStyle = l.state; ctx.beginPath(); ctx.arc(l.x+40, l.y+40, 6, 0, Math.PI*2); ctx.fill();
    });

    // Weather Effect (Rain)
    if(isRaining) {
        ctx.strokeStyle = "rgba(100,200,255,0.4)"; ctx.lineWidth = 1;
        raindrops.forEach(r => {
            ctx.beginPath(); ctx.moveTo(r.x, r.y); ctx.lineTo(r.x-2, r.y+r.s); ctx.stroke();
            r.y += r.s; if(r.y > canvas.height) { r.y = -10; r.x = Math.random()*canvas.width; }
        });
    }

    // Pedestrians
    peds.forEach(p => {
        let dx = p.tx-p.x, dy = p.ty-p.y, d = Math.sqrt(dx*dx+dy*dy);
        if(d > 2) { p.x += (dx/d)*p.s; p.y += (dy/d)*p.s; } else { p.tx = Math.random()*canvas.width; p.ty = Math.random()*canvas.height; }
        ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, 3, 3);
    });

    units.forEach(u => {
        let weatherPenalty = isRaining ? 0.6 : 1.0;
        let currentSpeed = (u.baseSpeed + (u.level * 0.2)) * weatherPenalty;

        if(u.status === 'IDLE') {
            if(u.patrolDir === 'x') u.x += currentSpeed; else u.y += currentSpeed;
            if(u.x > canvas.width) u.x = 0; if(u.y > canvas.height) u.y = 0;
        } else if(u.status === 'ENROUTE' && u.targetCrime) {
            let dx = u.targetCrime.x - u.x, dy = u.targetCrime.y - u.y;
            if(Math.abs(dx) > 5) u.x += Math.sign(dx) * currentSpeed;
            else if(Math.abs(dy) > 5) u.y += Math.sign(dy) * currentSpeed;
            else u.status = 'ON_SCENE';
        }
        
        ctx.fillStyle = u.color; ctx.beginPath(); ctx.moveTo(u.x-10, u.y-5); ctx.lineTo(u.x+8, u.y-5); ctx.lineTo(u.x+10, u.y); ctx.lineTo(u.x+8, u.y+5); ctx.lineTo(u.x-10, u.y+5); ctx.fill();
        if(u.status === 'ENROUTE') { ctx.fillStyle = (Date.now()%200<100)?'red':'blue'; ctx.fillRect(u.x-10, u.y-8, 20, 2); }
    });

    crimes.forEach((c, i) => {
        ctx.fillStyle = c.color; ctx.beginPath(); ctx.arc(c.x, c.y, 14, 0, Math.PI*2); ctx.fill();
        const onsite = units.filter(u => u.targetCrime === c && u.status === 'ON_SCENE');
        if(onsite.length > 0) {
            let totalPwr = onsite.reduce((sum, u) => sum + (u.basePwr + u.level*0.2), 0);
            c.progress -= 0.1 * totalPwr;
            if(c.progress <= 0) { 
                money += 500; crimes.splice(i, 1); wantedLevel = Math.max(0, wantedLevel - 0.3);
                onsite.forEach(u => { u.xp += 50; if(u.xp >= 100) { u.level++; u.xp = 0; } u.status = 'IDLE'; u.targetCrime = null; });
                updateUI(); 
            }
        }
    });

    requestAnimationFrame(gameLoop);
}

canvas.addEventListener('mousedown', (e) => {
    crimes.forEach(c => { if(Math.sqrt((e.offsetX-c.x)**2+(e.offsetY-c.y)**2) < 30) { selectedCrime = c; dMenu.style.display='block'; dMenu.style.left=e.clientX+'px'; dMenu.style.top=e.clientY+'px'; } });
});

function updateUI() {
    document.getElementById('money').innerText = `$${money}`;
    let stars = "☆☆☆☆☆".split(""); for(let i=0; i<Math.floor(wantedLevel); i++) stars[i] = "★";
    document.getElementById('wanted-level').innerText = stars.join("");
    const bar = document.getElementById('fleet-bar');
    bar.innerHTML = units.map(u => `
        <div class="fleet-unit">
            <strong>${u.type} (LVL ${u.level})</strong>
            <span>XP: ${u.xp}/100</span>
            <span style="color:${u.status === 'IDLE' ? 'green' : 'red'}">${u.status}</span>
        </div>
    `).join('');
}
</script>
</body>
</html>

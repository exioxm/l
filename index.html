<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nitro Racer: Cyber Pursuit v1.0</title>
    <style>
        body { margin: 0; background: #010103; overflow: hidden; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-container { position: relative; width: 440px; height: 750px; background: #050508; border: 2px solid #00f2ff; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2); }
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui, .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff; z-index: 10; }
        #ui { justify-content: flex-start; padding-top: 20px; visibility: hidden; }
        .overlay { pointer-events: auto; background: rgba(5, 5, 10, 0.9); backdrop-filter: blur(8px); transition: 0.3s; }
        .hidden { display: none !important; }
        
        .stat-row { width: 90%; display: flex; justify-content: space-between; background: rgba(0, 242, 255, 0.1); padding: 10px; border-radius: 5px; border-bottom: 2px solid #00f2ff; box-sizing: border-box; }
        .label { font-size: 9px; color: #00f2ff; text-transform: uppercase; letter-spacing: 1px; }
        .val { font-size: 20px; font-weight: 900; text-shadow: 0 0 8px #00f2ff; font-family: monospace; }
        
        h1 { color: #00f2ff; font-size: 32px; font-style: italic; text-shadow: 0 0 15px #00f2ff; margin-bottom: 5px; }
        .btn { width: 220px; padding: 12px; margin: 6px; background: transparent; border: 1px solid #00f2ff; color: #00f2ff; font-weight: bold; cursor: pointer; transition: 0.2s; text-transform: uppercase; }
        .btn:hover { background: #00f2ff; color: #000; box-shadow: 0 0 20px #00f2ff; }
        
        #wanted span { font-size: 24px; color: #333; margin: 0 3px; transition: 0.3s; }
        #wanted span.active { color: #ff0044; text-shadow: 0 0 10px #ff0044; }
        
        .garage-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 90%; max-height: 250px; overflow-y: auto; margin-top: 10px; }
        .car-card { border: 1px solid #222; padding: 10px; cursor: pointer; text-align: center; font-size: 11px; background: rgba(255,255,255,0.03); }
        .car-card.selected { border-color: #00f2ff; background: rgba(0, 242, 255, 0.15); }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- Gameplay HUD -->
    <div id="ui">
        <div class="stat-row">
            <div><div class="label">Distance</div><div class="val" id="score">0</div></div>
            <div><div class="label">Speed</div><div class="val" id="speedDisp">0</div></div>
            <div><div class="label">Credits</div><div class="val" id="creditsUI">0</div></div>
        </div>
        <div id="wanted" style="margin-top:15px;">
            <span id="s1">★</span><span id="s2">★</span><span id="s3">★</span><span id="s4">★</span><span id="s5">★</span>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="menu" class="overlay">
        <h1>NITRO RACER</h1>
        <div style="color:#ffcc00; margin-bottom:15px; font-family: monospace;">CREDITS: <span id="crMenu">0</span></div>
        <button class="btn" onclick="startGame('NORMAL', 1)">Arcade Drive</button>
        <button class="btn" style="border-color:#ff0044; color:#ff0044;" onclick="openPanel('pursuit-menu')">High Pursuit</button>
        <button class="btn" style="border-color:#00ff88; color:#00ff88;" onclick="openPanel('garage')">The Garage</button>
        <button class="btn" style="border-color:#555; color:#777; font-size:10px; margin-top:20px;" onclick="toggleDebug()">[ DEBUG MODE ]</button>
    </div>

    <!-- Pursuit Menu -->
    <div id="pursuit-menu" class="overlay hidden">
        <h1 style="color:#ff0044;">WANTED</h1>
        <p>SELECT ESCAPE PROTOCOL</p>
        <button class="btn" onclick="startGame('PURSUIT', 1)">Solo Escape</button>
        <button class="btn" onclick="startGame('PURSUIT', 2)">Duo Escape</button>
        <button class="btn" onclick="openPanel('menu')">Back</button>
    </div>

    <!-- Garage -->
    <div id="garage" class="overlay hidden">
        <h1>GARAGE</h1>
        <canvas id="carPreviewCanvas" width="120" height="160" style="border: 1px solid #00f2ff; background: #000;"></canvas>
        <div class="garage-grid" id="carGrid"></div>
        <button class="btn" style="margin-top:15px;" onclick="openPanel('menu')">Confirm</button>
    </div>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 440; canvas.height = 750;
    
    const ptx = document.getElementById("carPreviewCanvas").getContext("2d");

    // Game Constants & State
    const VERSION = "v1.0";
    let showDebug = false;
    let credits = parseInt(localStorage.getItem('nitroCr')) || 1000;
    let unlockedCars = JSON.parse(localStorage.getItem('nitroCars')) || ['Specter'];
    let currentCar = localStorage.getItem('nitroActiveCar') || 'Specter';
    let p1Color = '#00f2ff';

    const carData = {
        'Specter': { w: 42, h: 84, price: 0, speed: 8 },
        'Interceptor': { w: 36, h: 88, price: 5000, speed: 11 },
        'Goliath': { w: 54, h: 82, price: 12000, speed: 6 },
        'Venom': { w: 40, h: 90, price: 25000, speed: 14 }
    };

    let gameState = 'MENU', gameMode = 'NORMAL', playerCount = 1;
    let score = 0, speed = 0, frames = 0, enemies = [], keys = {};
    let lastTime = 0, fps = 0;
    let p1 = { x: 150, y: 600, alive: true }, p2 = { x: 250, y: 600, alive: true };

    // Event Listeners
    window.addEventListener("keydown", (e) => keys[e.code] = true);
    window.addEventListener("keyup", (e) => keys[e.code] = false);

    function toggleDebug() {
        showDebug = !showDebug;
        alert(`Debug Mode: ${showDebug ? 'ON' : 'OFF'}\nVersion: ${VERSION}`);
    }

    function openPanel(id) {
        document.querySelectorAll('.overlay').forEach(p => p.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'garage') { renderGarage(); drawPreview(); }
        updateCurrencyUI();
    }

    function updateCurrencyUI() {
        document.getElementById('crMenu').innerText = credits.toLocaleString();
        document.getElementById('creditsUI').innerText = credits.toLocaleString();
    }

    function renderGarage() {
        const grid = document.getElementById('carGrid'); grid.innerHTML = '';
        for(let name in carData) {
            const data = carData[name];
            const isOwned = unlockedCars.includes(name);
            const card = document.createElement('div');
            card.className = `car-card ${currentCar === name ? 'selected' : ''}`;
            card.innerHTML = `<b>${name}</b><br>${isOwned ? 'OWNED' : '$'+data.price}`;
            card.onclick = () => {
                if(isOwned) { currentCar = name; }
                else if(credits >= data.price) {
                    credits -= data.price; unlockedCars.push(name); currentCar = name;
                }
                localStorage.setItem('nitroCr', credits);
                localStorage.setItem('nitroCars', JSON.stringify(unlockedCars));
                localStorage.setItem('nitroActiveCar', currentCar);
                renderGarage(); drawPreview();
            };
            grid.appendChild(card);
        }
    }

    function drawPreview() {
        ptx.clearRect(0,0,120,160);
        const d = carData[currentCar];
        ptx.fillStyle = p1Color;
        ptx.fillRect(60-d.w/2, 80-d.h/2, d.w, d.h);
        ptx.strokeStyle = "#fff"; ptx.strokeRect(60-d.w/2, 80-d.h/2, d.w, d.h);
    }

    function startGame(mode, count) {
        gameState = 'PLAY'; gameMode = mode; playerCount = count;
        score = 0; speed = carData[currentCar].speed; enemies = []; frames = 0;
        p1 = { x: 150, y: 600, alive: true };
        p2 = { x: 250, y: 600, alive: true };
        document.querySelectorAll('.overlay').forEach(p => p.classList.add('hidden'));
        document.getElementById('ui').style.visibility = 'visible';
        updateCurrencyUI();
        gameLoop(performance.now());
    }

    function spawnEnemy() {
        const lane = Math.floor(Math.random() * 4);
        const isPolice = (gameMode === 'PURSUIT' && Math.random() > 0.4);
        enemies.push({
            x: 60 + (lane * 80), y: -100, 
            w: 40, h: 80, 
            v: 2 + Math.random() * 3,
            type: isPolice ? 'POLICE' : 'CIV',
            color: isPolice ? '#ff0044' : '#444'
        });
    }

    function update() {
        frames++; score++; speed += 0.002;
        const d = carData[currentCar];

        if(keys['ArrowLeft'] && p1.x > 50) p1.x -= 6;
        if(keys['ArrowRight'] && p1.x < 390 - d.w) p1.x += 6;
        if(playerCount > 1) {
            if(keys['KeyA'] && p2.x > 50) p2.x -= 6;
            if(keys['KeyD'] && p2.x < 390 - d.w) p2.x += 6;
        }

        if(frames % 50 === 0) spawnEnemy();

        // Wanted Stars Logic
        const wantedLevel = Math.min(5, Math.floor(score / 2500));
        for(let i=1; i<=5; i++) {
            document.getElementById('s'+i).className = (i <= wantedLevel) ? 'active' : '';
        }

        enemies.forEach((e, i) => {
            e.y += speed - e.v;
            
            // AI Steer
            if(e.type === 'POLICE' && e.y < p1.y) {
                if(e.x < p1.x) e.x += 1.2;
                if(e.x > p1.x) e.x -= 1.2;
            }

            // Hit Detection
            [p1, p2].forEach((p, idx) => {
                if((idx === 1 && playerCount < 2) || !p.alive) return;
                if(p.x < e.x + e.w && p.x + d.w > e.x && p.y < e.y + e.h && p.y + d.h > e.y) {
                    p.alive = false;
                    if(playerCount === 1 || (!p1.alive && !p2.alive)) endGame();
                }
            });

            if(e.y > 800) { enemies.splice(i, 1); credits += 5; }
        });

        document.getElementById('score').innerText = Math.floor(score/10);
        document.getElementById('speedDisp').innerText = Math.floor(speed * 15) + " MPH";
    }

    function draw() {
        ctx.fillStyle = "#050508"; ctx.fillRect(0,0,440,750);
        
        // Road
        ctx.strokeStyle = "rgba(0, 242, 255, 0.1)";
        for(let i=0; i<5; i++) {
            ctx.beginPath(); ctx.moveTo(50 + i*85, 0); ctx.lineTo(50 + i*85, 750); ctx.stroke();
        }

        const d = carData[currentCar];
        if(p1.alive) {
            ctx.shadowBlur = 15; ctx.shadowColor = p1Color;
            ctx.fillStyle = p1Color; ctx.fillRect(p1.x, p1.y, d.w, d.h);
            ctx.shadowBlur = 0;
        }
        if(playerCount > 1 && p2.alive) {
            ctx.fillStyle = "#ff00ff"; ctx.fillRect(p2.x, p2.y, d.w, d.h);
        }

        enemies.forEach(e => {
            ctx.fillStyle = e.color; ctx.fillRect(e.x, e.y, e.w, e.h);
            if(e.type === 'POLICE' && frames % 20 < 10) {
                ctx.fillStyle = (frames % 10 < 5) ? '#ff0000' : '#0000ff';
                ctx.fillRect(e.x, e.y, e.w, 8);
            }
        });

        if(showDebug) drawDebug();
    }

    function drawDebug() {
        ctx.fillStyle = "rgba(0,0,0,0.8)";
        ctx.fillRect(5, 80, 160, 110);
        ctx.fillStyle = "#00ff00";
        ctx.font = "12px monospace";
        ctx.fillText(`NITRO DEBUG ${VERSION}`, 10, 95);
        ctx.fillText(`FPS: ${fps}`, 10, 115);
        ctx.fillText(`ENTITIES: ${enemies.length}`, 10, 135);
        ctx.fillText(`SPEED: ${speed.toFixed(2)}`, 10, 155);
        ctx.fillText(`POS: ${Math.round(p1.x)}x${Math.round(p1.y)}`, 10, 175);
    }

    function endGame() {
        gameState = 'MENU';
        const earned = Math.floor(score/10);
        credits += earned;
        localStorage.setItem('nitroCr', credits);
        alert(`WRECKED! Earned $${earned}`);
        document.getElementById('ui').style.visibility = 'hidden';
        openPanel('menu');
    }

    function gameLoop(timestamp) {
        if(gameState === 'PLAY') {
            fps = Math.round(1000 / (timestamp - lastTime));
            lastTime = timestamp;
            update(); draw(); requestAnimationFrame(gameLoop);
        }
    }

    updateCurrencyUI();
</script>
</body>
</html>

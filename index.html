<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nitro Racer: Final Edition</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; }
        
        #game-container { position: relative; width: 440px; height: 750px; background: #020208; box-shadow: 0 0 50px rgba(0, 242, 255, 0.4); }
        canvas { display: block; width: 100%; height: 100%; border: none; }
        
        #ui, .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff; z-index: 10; }
        #ui { justify-content: flex-start; padding-top: 20px; visibility: hidden; }
        .overlay { pointer-events: auto; background: rgba(2, 2, 12, 0.95); transition: 0.3s; }
        .hidden { display: none !important; }
        
        .stat-row { width: 380px; display: flex; justify-content: space-between; }
        .label { font-size: 10px; color: #00f2ff; text-transform: uppercase; }
        .val { font-size: 22px; font-weight: 900; text-shadow: 0 0 10px #00f2ff; font-family: monospace; }
        
        h1 { color: #00f2ff; font-size: 40px; margin: 0; font-style: italic; text-shadow: 0 0 20px #00f2ff; }
        .credits-info { margin: 10px 0 20px; font-family: monospace; color: #ffcc00; }
        
        .btn { width: 240px; padding: 12px; margin: 5px; background: rgba(0, 242, 255, 0.1); border: 1px solid #00f2ff; color: #00f2ff; font-weight: bold; cursor: pointer; transition: 0.2s; text-transform: uppercase; }
        
        .garage-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px; width: 90%; max-height: 200px; overflow-y: auto; padding: 5px; }
        .car-card { border: 1px solid #333; padding: 10px; cursor: pointer; text-align: center; font-size: 11px; background: rgba(255,255,255,0.05); }
        .car-card.selected { border-color: #00f2ff; box-shadow: 0 0 10px #00f2ff; background: rgba(0,242,255,0.1); }
        .color-dot { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; margin: 5px; }

        #admin-link { position: absolute; top: 15px; right: 15px; font-size: 11px; font-weight: bold; cursor: pointer; color: #333; pointer-events: auto; z-index: 100; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="ui">
        <div class="stat-row">
            <div><div class="label">Distance</div><div class="val" id="score">0</div></div>
            <div><div class="label">MPH</div><div class="val" id="speedDisp">0</div></div>
            <div><div class="label">Credits</div><div class="val" id="creditsUI">0</div></div>
        </div>
        <div id="wanted" style="margin-top:10px; font-size:24px; color:rgba(255,255,255,0.1); letter-spacing:5px;">
            <span id="s1">★</span><span id="s2">★</span><span id="s3">★</span><span id="s4">★</span><span id="s5">★</span>
        </div>
    </div>

    <div id="menu" class="overlay">
        <div id="admin-link" onclick="checkAdmin()">[SECRET ACCESS]</div>
        <h1>NITRO RACER</h1>
        <div class="credits-info">CREDITS: <span id="crMenu">0</span></div>
        <button class="btn" onclick="startGame('NORMAL', 1)">Single Drive</button>
        <button class="btn" onclick="startGame('DUO', 2)">Duo Drive</button>
        <button class="btn" style="border-color:#ff0044; color:#ff0044;" onclick="openPanel('pursuit-menu')">Police Pursuit</button>
        <button class="btn" style="border-color:#fff; color:#fff;" onclick="openPanel('garage')">Customize Garage</button>
    </div>

    <div id="pursuit-menu" class="overlay hidden">
        <h1 style="color:#ff0044;">PURSUIT</h1>
        <p>SELECT UNIT COUNT</p>
        <button class="btn" onclick="startGame('PURSUIT', 1)">Solo Escape</button>
        <button class="btn" onclick="startGame('PURSUIT', 2)">Duo Escape</button>
        <button class="btn" onclick="openPanel('menu')">Back</button>
    </div>

    <div id="garage" class="overlay hidden">
        <h1>GARAGE</h1>
        <div class="credits-info">CREDITS: <span id="crGarage">0</span></div>
        <!-- Car Preview Canvas -->
        <canvas id="carPreviewCanvas" width="150" height="200" style="border: 1px solid #00f2ff; margin-bottom: 10px;"></canvas>

        <div class="garage-grid" id="carGrid"></div>
        <div style="display:flex;">
            <div class="color-dot" style="background:#00f2ff" onclick="setColor('#00f2ff')"></div>
            <div class="color-dot" style="background:#ff00ff" onclick="setColor('#ff00ff')"></div>
            <div class="color-dot" style="background:#ffff00" onclick="setColor('#ffff00')"></div>
            <div class="color-dot" style="background:#00ff00" onclick="setColor('#00ff00')"></div>
        </div>
        <button class="btn" onclick="openPanel('menu')">Save & Back</button>
    </div>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 440; canvas.height = 750;
    
    // Preview Canvas
    const previewCanvas = document.getElementById("carPreviewCanvas");
    const ptx = previewCanvas.getContext("2d");

    let credits = parseInt(localStorage.getItem('nitroCr')) || 0;
    let unlockedCars = JSON.parse(localStorage.getItem('nitroCars')) || ['Specter'];
    let currentCar = localStorage.getItem('nitroActiveCar') || 'Specter';
    let p1Color = localStorage.getItem('nitroColor') || '#00f2ff';

    const carData = {
        'Specter': { w: 42, h: 84, price: 0, desc: 'Balanced' },
        'Interceptor': { w: 34, h: 90, price: 5000, desc: 'Slim & Fast' },
        'Goliath': { w: 52, h: 80, price: 10000, desc: 'Heavy Tank' },
        'Rainbow': { w: 45, h: 88, price: 99999, desc: 'ADMIN ONLY' }
    };

    let gameState = 'START', gameMode = 'NORMAL', playerCount = 1;
    let score = 0, targetSpeed = 8, frames = 0, enemies = [], keys = {};
    const p1 = { x: 200, y: 580, alive: true }, p2 = { x: 280, y: 580, alive: true };

    function checkAdmin() {
        if (prompt("ENTER ADMIN KEY:") === '123') {
            credits = 999999;
            if (!unlockedCars.includes('Rainbow')) unlockedCars.push('Rainbow');
            localStorage.setItem('nitroCr', credits); localStorage.setItem('nitroCars', JSON.stringify(unlockedCars));
            updateCurrencyUI(); renderGarage(); alert("ADMIN ACTIVATED");
        }
    }

    function updateCurrencyUI() {
        document.getElementById('crMenu').innerText = credits.toLocaleString();
        document.getElementById('crGarage').innerText = credits.toLocaleString();
        document.getElementById('creditsUI').innerText = credits.toLocaleString();
    }
    updateCurrencyUI();

    window.addEventListener("keydown", (e) => keys[e.code] = true);
    window.addEventListener("keyup", (e) => keys[e.code] = false);

    function openPanel(id) {
        document.querySelectorAll('.overlay').forEach(p => p.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'garage') renderGarage();
    }

    function renderGarage() {
        const grid = document.getElementById('carGrid'); grid.innerHTML = '';
        for(let name in carData) {
            const data = carData[name];
            const isUnlocked = unlockedCars.includes(name);
            const card = document.createElement('div');
            card.className = `car-card ${currentCar === name ? 'selected' : ''}`;
            card.innerHTML = `<b>${name}</b><br>${isUnlocked ? '(OWNED)' : '$'+data.price}`;
            card.onclick = () => {
                if(isUnlocked) { 
                    currentCar = name; 
                    localStorage.setItem('nitroActiveCar', name); 
                    renderGarage(); 
                } else if (credits >= data.price) {
                    credits -= data.price; unlockedCars.push(name);
                    localStorage.setItem('nitroCr', credits); localStorage.setItem('nitroCars', JSON.stringify(unlockedCars));
                    updateCurrencyUI(); renderGarage();
                }
            };
            grid.appendChild(card);
        }
        drawCar(50, 60, p1Color, currentCar, 'player', ptx);
    }

    function setColor(c) { 
        p1Color = c; 
        localStorage.setItem('nitroColor', c); 
        drawCar(50, 60, p1Color, currentCar, 'player', ptx);
    }

    function startGame(mode, count) {
        gameMode = mode; playerCount = count; gameState = 'PLAYING';
        score = 0; targetSpeed = 8; enemies = []; frames = 0;
        p1.x = playerCount === 2 ? 120 : 200; p1.alive = true;
        p2.x = 280; p2.alive = (playerCount === 2);
        document.querySelectorAll('.overlay').forEach(p => p.classList.add('hidden'));
        document.getElementById('ui').style.visibility = 'visible';
    }

    // Pass the context to the draw function
    function drawCar(x, y, color, carName, type, context = ctx) {
        const d = carData[carName] || carData['Specter'];
        context.save();
        let displayColor = color;
        if (carName === 'Rainbow') {
            const colors = ['#ff0000', '#ffff00', '#00ff00', '#00ffff', '#0000ff', '#ff00ff'];
            displayColor = colors[Math.floor(frames / 5) % colors.length];
        }
        context.shadowBlur = 10; context.shadowColor = displayColor;
        context.strokeStyle = displayColor; context.lineWidth = 2;
        context.beginPath();
        if(carName === 'Specter' || carName === 'Rainbow') {
            context.moveTo(x + d.w/2, y); context.lineTo(x + d.w, y + d.h*0.3); context.lineTo(x + d.w*0.8, y + d.h*0.9); context.lineTo(x + d.w*0.2, y + d.h*0.9); context.lineTo(x, y + d.h*0.3);
        } else if(carName === 'Interceptor') {
            context.moveTo(x + d.w/2, y); context.lineTo(x + d.w, y + d.h); context.lineTo(x, y + d.h);
        } else if (carName === 'Goliath') {
            context.rect(x, y, d.w, d.h);
        }
        context.closePath(); context.fillStyle = "#050505"; context.fill(); context.stroke();
        if(type === 'police') {
            context.fillStyle = (Math.floor(frames/8)%2) ? "#ff0044" : "#00aaff";
            context.fillRect(x + d.w*0.2, y + 5, d.w*0.6, 5);
        }
        context.restore();
    }

    function update() {
        if(gameState !== 'PLAYING') return;
        frames++;
        
        let throttle = (keys['KeyW'] || keys['ArrowUp']) ? 0.08 : (keys['KeyS'] || keys['ArrowDown']) ? -0.15 : -0.02;
        targetSpeed = Math.max(5, Math.min(18, targetSpeed + throttle));
        
        score += Math.floor(targetSpeed * 0.1);
        credits += 1;
        document.getElementById('score').innerText = score;
        document.getElementById('speedDisp').innerText = Math.floor(targetSpeed * 15);
        updateCurrencyUI();

        const p1Dims = carData[currentCar];
        if(p1.alive) {
            if(keys['KeyA']) p1.x -= 8; if(keys['KeyD']) p1.x += 8;
            p1.x = Math.max(10, Math.min(canvas.width - p1Dims.w - 10, p1.x));
        }
        if(p2.alive && playerCount === 2) {
            if(keys['ArrowLeft']) p2.x -= 8; if(keys['ArrowRight']) p2.x += 8;
            p2.x = Math.max(10, Math.min(canvas.width - p1Dims.w - 10, p2.x));
        }

        if (frames % 35 === 0) enemies.push({ x: 30 + Math.random() * 350, y: -100, w: 40, h: 80, isPolice: gameMode === 'PURSUIT' });

        enemies.forEach((e, i) => {
            e.y += targetSpeed + 2;
            if(e.y > canvas.height) enemies.splice(i, 1);
            if(p1.alive) {
                if(p1.x < e.x + e.w && p1.x + p1Dims.w > e.x && p1.y < e.y + e.h && p1.y + p1Dims.h > e.y) endGame();
            }
            if(p2.alive && playerCount === 2) {
                if(p2.x < e.x + e.w && p2.x + p1Dims.w > e.x && p2.y < e.y + e.h && p2.y + p1Dims.h > e.y) endGame();
            }
        });
        
        if (gameMode === 'PURSUIT') {
            const wl = Math.min(5, Math.floor(score / 2000) + 1);
            for(let i=1; i<=5; i++) document.getElementById('s'+i).style.color = (i <= wl) ? '#ff0044' : 'rgba(255,255,255,0.1)';
        }
    }

    function draw() {
        ctx.clearRect(0,0, canvas.width, canvas.height); 
        ctx.fillStyle = "#020208"; ctx.fillRect(0, 0, canvas.width, canvas.height);

        if(gameState === 'PLAYING') {
             if(gameMode === 'PURSUIT' && Math.floor(frames/15)%2===0) {
                const wl = Math.min(5, Math.floor(score / 2000) + 1);
                if(wl >= 4) {
                    ctx.fillStyle = (Math.floor(frames/8)%2) ? "rgba(255, 0, 68, 0.15)" : "rgba(0, 85, 255, 0.15)";
                    ctx.fillRect(0,0, canvas.width, canvas.height);
                }
            }
            enemies.forEach(e => drawCar(e.x, e.y, e.isPolice ? "#00aaff" : "#ff0044", 'Specter', e.isPolice ? 'police' : 'traffic'));
            if(p1.alive) drawCar(p1.x, p1.y, p1Color, currentCar, 'player');
            if(p2.alive && playerCount === 2) drawCar(p2.x, p2.y, "#ffcc00", currentCar, 'player');
        }
        requestAnimationFrame(draw);
    }

    function endGame() {
        localStorage.setItem('nitroCr', credits);
        if(score > highScore) localStorage.setItem('nitroHigh', score);
        gameState = 'START'; document.getElementById('ui').style.visibility = 'hidden';
        openPanel('menu');
    }
    draw();
</script>
</body>
</html>

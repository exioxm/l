<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nitro Racer: Velocity Pursuit</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-container { position: relative; width: 440px; height: 750px; }
        canvas { background: #020208; border: 2px solid #00f2ff; box-shadow: 0 0 50px rgba(0, 242, 255, 0.4); display: block; }
        
        #ui, #menu, #pursuit-menu { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #ui { justify-content: flex-start; padding-top: 20px; visibility: hidden; }
        .stat-row { width: 380px; display: flex; justify-content: space-between; color: #fff; }
        .label { font-size: 10px; color: #00f2ff; text-transform: uppercase; letter-spacing: 1px; }
        .val { font-size: 22px; font-weight: 900; text-shadow: 0 0 10px #00f2ff; font-family: monospace; }
        
        #menu, #pursuit-menu { pointer-events: auto; background: rgba(2, 2, 12, 0.95); z-index: 20; }
        .hidden { display: none !important; }
        
        h1 { color: #00f2ff; font-size: 42px; margin: 0; text-shadow: 0 0 20px #00f2ff; font-style: italic; }
        .record { color: #fff; font-family: monospace; margin-bottom: 30px; opacity: 0.8; }
        
        .btn {
            width: 240px; padding: 15px; margin: 8px;
            background: rgba(0, 242, 255, 0.05); border: 1px solid #00f2ff; color: #00f2ff;
            font-weight: bold; text-transform: uppercase; cursor: pointer;
            transition: 0.2s; letter-spacing: 2px;
        }
        .btn:hover { background: #00f2ff; color: #000; box-shadow: 0 0 30px #00f2ff; }
        .btn.pursuit { border-color: #ff0044; color: #ff0044; }
        .btn.pursuit:hover { background: #ff0044; color: #fff; box-shadow: 0 0 30px #ff0044; }

        #wanted { margin-top: 10px; font-size: 24px; color: #222; letter-spacing: 5px; }
        .star-active { color: #ff0044; text-shadow: 0 0 10px #ff0044; }
        .hint { position: absolute; bottom: 30px; color: #555; font-size: 11px; text-align: center; width: 100%; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="ui">
        <div class="stat-row">
            <div><div class="label">Distance</div><div class="val" id="score">0</div></div>
            <div><div class="label">Velocity</div><div class="val" id="speedDisp">0 <span style="font-size:12px">MPH</span></div></div>
            <div><div class="label">Record</div><div class="val" id="highScoreUI">0</div></div>
        </div>
        <div id="wanted">
            <span id="s1">★</span><span id="s2">★</span><span id="s3">★</span><span id="s4">★</span><span id="s5">★</span>
        </div>
    </div>

    <div id="menu">
        <h1>NITRO RACER</h1>
        <div class="record">TOP RECORD: <span id="highScoreMenu">0</span>M</div>
        <button class="btn" onclick="startMode('NORMAL', 1)">Single Drive</button>
        <button class="btn" onclick="startMode('DUO', 2)">Duo Drive</button>
        <button class="btn pursuit" onclick="showPursuitMenu()">Police Pursuit</button>
        <div class="hint">W/S or UP/DOWN to control Speed</div>
    </div>

    <div id="pursuit-menu" class="hidden">
        <h1 style="color:#ff0044; text-shadow: 0 0 20px #ff0044;">WANTED</h1>
        <div class="record" style="color:#ff0044">SELECT UNIT COUNT</div>
        <button class="btn pursuit" onclick="startMode('PURSUIT', 1)">Solo Escape</button>
        <button class="btn pursuit" onclick="startMode('PURSUIT', 2)">Duo Escape</button>
        <button class="btn" style="border-color:#555; color:#555;" onclick="showMainMenu()">Back</button>
    </div>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const ui = document.getElementById("ui");
    const menu = document.getElementById("menu");
    const pursuitMenu = document.getElementById("pursuit-menu");
    const scoreVal = document.getElementById("score");
    const speedVal = document.getElementById("speedDisp");
    const highVal = document.getElementById("highScoreUI");
    const highMenuVal = document.getElementById("highScoreMenu");

    canvas.width = 440;
    canvas.height = 750;

    let gameState = 'START';
    let gameMode = 'NORMAL'; 
    let playerCount = 1;
    let score = 0;
    let wantedLevel = 0;
    let highScore = localStorage.getItem('nitroHigh') || 0;
    let speedMPH = 0;
    let targetSpeed = 8;
    let frames = 0;
    let enemies = [];
    let keys = {};

    highMenuVal.innerText = Number(highScore).toLocaleString();

    window.addEventListener("keydown", (e) => keys[e.code] = true);
    window.addEventListener("keyup", (e) => keys[e.code] = false);

    function showPursuitMenu() { menu.classList.add('hidden'); pursuitMenu.classList.remove('hidden'); }
    function showMainMenu() { pursuitMenu.classList.add('hidden'); menu.classList.remove('hidden'); }

    const p1 = { x: 200, y: 580, w: 42, h: 84, color: "#00f2ff", alive: true };
    const p2 = { x: 280, y: 580, w: 42, h: 84, color: "#ffcc00", alive: true };

    function startMode(mode, count) {
        gameMode = mode; playerCount = count; gameState = 'PLAYING';
        score = 0; speedMPH = 60; targetSpeed = 8; wantedLevel = 0; enemies = [];
        p1.x = playerCount === 2 ? 120 : 200; p1.alive = true;
        p2.x = 280; p2.alive = playerCount === 2;
        menu.classList.add('hidden'); pursuitMenu.classList.add('hidden');
        ui.style.visibility = 'visible';
        document.getElementById('wanted').style.visibility = mode === 'PURSUIT' ? 'visible' : 'hidden';
        highVal.innerText = Number(highScore).toLocaleString();
    }

    function drawCar(x, y, w, h, color, type) {
        ctx.save();
        ctx.shadowBlur = 15; ctx.shadowColor = color;
        ctx.strokeStyle = color; ctx.lineWidth = 2;
        ctx.beginPath();
        if (type === 'player') {
            ctx.moveTo(x + w/2, y); ctx.lineTo(x + w, y + h*0.3); ctx.lineTo(x + w*0.8, y + h*0.9);
            ctx.lineTo(x + w*0.2, y + h*0.9); ctx.lineTo(x, y + h*0.3);
        } else {
            ctx.moveTo(x + w*0.1, y); ctx.lineTo(x + w*0.9, y); ctx.lineTo(x + w, y + h*0.2);
            ctx.lineTo(x + w, y + h*0.8); ctx.lineTo(x + w*0.7, y + h); ctx.lineTo(x + w*0.3, y + h);
            ctx.lineTo(x, y + h*0.8); ctx.lineTo(x, y + h*0.2);
        }
        ctx.closePath(); ctx.fillStyle = "#050505"; ctx.fill(); ctx.stroke();
        if(type === 'police') {
            const flash = Math.floor(frames / 8) % 2 === 0;
            ctx.fillStyle = flash ? "#ff0044" : "#00aaff";
            ctx.fillRect(x + w*0.2, y + h*0.1, w*0.6, 6);
        }
        ctx.restore();
    }

    function update() {
        if(gameState !== 'PLAYING') return;
        frames++;
        
        // MPH and Base Speed Logic
        let baseMax = 12 + (gameMode === 'PURSUIT' ? wantedLevel : 0);
        let currentThrottle = 0;
        if (keys['KeyW'] || keys['ArrowUp']) currentThrottle = 1;
        if (keys['KeyS'] || keys['ArrowDown']) currentThrottle = -1;

        if (currentThrottle > 0) targetSpeed += 0.05;
        else if (currentThrottle < 0) targetSpeed -= 0.1;
        else targetSpeed *= 0.99; // Natural drag

        targetSpeed = Math.max(6, Math.min(baseMax, targetSpeed));
        speedMPH = Math.floor(targetSpeed * 15);
        speedVal.innerHTML = `${speedMPH} <span style="font-size:12px">MPH</span>`;

        score += Math.floor(targetSpeed / 5);
        scoreVal.innerText = score.toLocaleString();

        if (gameMode === 'PURSUIT') {
            wantedLevel = Math.min(5, Math.floor(score / 2500) + 1);
            for(let i=1; i<=5; i++) document.getElementById('s'+i).className = i <= wantedLevel ? 'star-active' : '';
        }

        // Steering
        if(p1.alive) {
            if(keys['KeyA']) p1.x -= 8; if(keys['KeyD']) p1.x += 8;
            p1.x = Math.max(20, Math.min(canvas.width - p1.w - 20, p1.x));
        }
        if(p2.alive && playerCount === 2) {
            if(keys['ArrowLeft']) p2.x -= 8; if(keys['ArrowRight']) p2.x += 8;
            p2.x = Math.max(20, Math.min(canvas.width - p2.w - 20, p2.x));
        }

        // Enemies
        let spawnRate = gameMode === 'PURSUIT' ? Math.max(7, 35 - (wantedLevel * 5)) : 40;
        if (frames % Math.floor(spawnRate) === 0) {
            enemies.push({ x: 30 + Math.random() * (canvas.width - 90), y: -100, w: 46, h: 80, isPolice: gameMode === 'PURSUIT' });
        }

        enemies.forEach((e, i) => {
            e.y += targetSpeed + (gameMode === 'PURSUIT' ? wantedLevel * 0.4 : 1);
            if(e.y > canvas.height) enemies.splice(i, 1);
            [p1, p2].forEach(p => {
                if(p.alive && p.x < e.x + e.w-5 && p.x + p.w > e.x+5 && p.y < e.y + e.h-5 && p.y + p.h > e.y+5) p.alive = false;
            });
        });

        if(!p1.alive && (!p2.alive || playerCount === 1)) endGame();
    }

    function draw() {
        ctx.fillStyle = (gameMode === 'PURSUIT' && wantedLevel >= 4 && Math.floor(frames/15)%2===0) ? "#1a0000" : "#020208";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        if(gameState === 'PLAYING') {
            ctx.strokeStyle = "rgba(0, 242, 255, 0.05)";
            for(let i=0; i<8; i++) {
                let scroll = (frames * targetSpeed) % 63;
                ctx.beginPath(); ctx.moveTo(i * 63, 0); ctx.lineTo(i * 63, canvas.height); ctx.stroke();
            }
            enemies.forEach(e => drawCar(e.x, e.y, e.w, e.h, e.isPolice ? "#00aaff" : "#ff0044", e.isPolice ? 'police' : 'traffic'));
            if(p1.alive) drawCar(p1.x, p1.y, p1.w, p1.h, p1.color, 'player');
            if(p2.alive && playerCount === 2) drawCar(p2.x, p2.y, p2.w, p2.h, p2.color, 'player');
        }
        update(); requestAnimationFrame(draw);
    }

    function endGame() {
        if(score > highScore) { 
            highScore = score; 
            localStorage.setItem('nitroHigh', highScore);
            highMenuVal.innerText = Number(highScore).toLocaleString();
        }
        gameState = 'START'; ui.style.visibility = 'hidden'; 
        menu.classList.remove('hidden');
    }
    draw();
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>LASD: DTLA Patrol & Pursuit</title>
    <style>
        body { background: #000; color: white; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #game-container { position: relative; display: flex; border: 4px solid #444; }
        canvas { background: #111; cursor: crosshair; }
        .ui-top { position: absolute; top: -50px; width: 800px; display: flex; justify-content: space-between; font-size: 22px; font-weight: bold; color: #f1c40f; }
        #side-panel { width: 250px; background: #222; padding: 20px; border-left: 4px solid #f1c40f; overflow-y: auto; height: 500px; }
        .unit-card { background: #333; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 5px solid #f1c40f; cursor: pointer; font-size: 12px; }
        .btn-dispatch { background: #d35400; border: none; color: white; padding: 12px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #radio-log { position: absolute; bottom: 20px; left: 20px; width: 280px; height: 70px; background: rgba(0,0,0,0.8); padding: 10px; font-size: 11px; color: #2ecc71; pointer-events: none; border-radius: 5px; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="ui-top">
        <span>ðŸ’° $<span id="money">1000</span></span>
        <span>ðŸš” Units: <span id="fleet-count">1</span></span>
    </div>
    <canvas id="cityCanvas" width="800" height="500"></canvas>
    <div id="side-panel">
        <h3 style="margin-top:0; color:#f1c40f;">LASD DISPATCH</h3>
        <div class="unit-card" onclick="buy('crown')"><b>Crown Vic</b><br>$300</div>
        <div class="unit-card" onclick="buy('explorer')"><b>Explorer</b><br>$500</div>
        <div class="unit-card" onclick="buy('tahoe')"><b>Tahoe</b><br>$800</div>
        <div class="unit-card" onclick="buy('pierce')"><b>Pierce Command</b><br>$2500</div>
        <div class="unit-card" onclick="buy('air')"><b>Aero Bureau</b><br>$1500</div>
        <button class="btn-dispatch" onclick="dispatchAll()">DISPATCH ALL</button>
    </div>
    <div id="radio-log"></div>
</div>

<script>
const canvas = document.getElementById('cityCanvas');
const ctx = canvas.getContext('2d');
const tileSize = 50, cols = 16, rows = 10;

const cityMap = [
    [1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,0,1,1,1,1,1,2,2,1,1,0,1],
    [1,0,0,0,0,0,0,0,0,0,2,2,1,1,0,1],
    [1,0,1,1,1,1,1,1,1,0,1,1,1,1,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1]
];

let money = 1000, units = [], calls = [], frames = 0, selectedCall = null;

class Unit {
    constructor(type) {
        this.type = type;
        this.x = 10 * tileSize + 25; this.y = 3 * tileSize + 25;
        this.speed = (type === 'air') ? 3.5 : (type === 'pierce') ? 1.2 : 2.8;
        this.path = []; this.target = null;
    }
    update() {
        if (this.target) {
            let dx = this.target.x - this.x, dy = this.target.y - this.y, dist = Math.hypot(dx, dy);
            if (this.type === 'air') {
                if (dist > 5) { this.x += (dx/dist)*this.speed; this.y += (dy/dist)*this.speed; }
            } else {
                if (frames % 30 === 0 && this.target.isMoving) this.recalculatePath();
                if (this.path.length > 0) {
                    let next = this.path[0], tx = next.c * tileSize + 25, ty = next.r * tileSize + 25;
                    let dnx = tx - this.x, dny = ty - this.y, ddist = Math.hypot(dnx, dny);
                    if (ddist < 5) this.path.shift();
                    else { this.x += (dnx/ddist)*this.speed; this.y += (dny/ddist)*this.speed; }
                }
            }
            if (dist < 40) {
                this.target.progress += (this.type === 'pierce' ? 1.2 : 0.4) / (this.target.type === 'high' ? 4 : 1);
                if (this.target.progress >= 100) {
                    money += this.target.type === 'high' ? 2000 : 500;
                    calls = calls.filter(c => c !== this.target);
                    units.forEach(u => { if(u.target === this.target) u.target = null; });
                    playRadio(`Code 4. Suspect 10-15.`);
                }
            }
        }
    }
    recalculatePath() {
        let sr = Math.floor(this.y/tileSize), sc = Math.floor(this.x/tileSize);
        let tr = Math.floor(this.target.y/tileSize), tc = Math.floor(this.target.x/tileSize);
        this.path = findPath(sr, sc, tr, tc);
    }
    draw() {
        ctx.save(); ctx.translate(this.x, this.y);
        ctx.fillStyle = this.type === 'air' ? '#f1c40f' : (this.type === 'pierce' ? '#fff' : '#000');
        let w = this.type === 'pierce' ? 35 : 24, h = this.type === 'pierce' ? 18 : 12;
        ctx.fillRect(-w/2, -h/2, w, h);
        if (this.target) { ctx.fillStyle = frames % 10 < 5 ? 'red' : 'blue'; ctx.fillRect(w/4, -h/2, 6, 6); }
        ctx.restore();
    }
}

class Call {
    constructor(type) {
        this.type = type; // 'standard', 'high', 'moving'
        let r, c; do { r = Math.floor(Math.random()*rows); c = Math.floor(Math.random()*cols); } while(cityMap[r][c] !== 0);
        this.x = c * tileSize + 25; this.y = r * tileSize + 25;
        this.progress = 0; this.isMoving = type === 'moving';
        this.dir = {r: 0, c: 1}; this.speed = 1.5;
    }
    update() {
        if (this.isMoving && frames % 2 === 0) {
            let nx = this.x + this.dir.c*this.speed, ny = this.y + this.dir.r*this.speed;
            let gr = Math.floor(ny/tileSize), gc = Math.floor(nx/tileSize);
            if (cityMap[gr] && cityMap[gr][gc] === 0) { this.x = nx; this.y = ny; }
            else { this.dir = [{r:0,c:1},{r:0,c:-1},{r:1,c:0},{r:-1,c:0}][Math.floor(Math.random()*4)]; }
        }
    }
    draw() {
        if (selectedCall === this) { ctx.strokeStyle = '#f1c40f'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(this.x, this.y, 25, 0, Math.PI*2); ctx.stroke(); }
        ctx.fillStyle = this.type === 'high' ? '#9b59b6' : (this.type === 'moving' ? '#e74c3c' : '#3498db');
        ctx.beginPath(); ctx.arc(this.x, this.y, 10, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#2ecc71'; ctx.fillRect(this.x-15, this.y+15, (this.progress/100)*30, 5);
        ctx.fillStyle = 'white'; ctx.font = '9px Arial'; ctx.fillText(this.type.toUpperCase(), this.x-15, this.y-15);
    }
}

function findPath(sr, sc, tr, tc) {
    let queue = [[{r: sr, c: sc}]], visited = new Set([`${sr},${sc}`]);
    while (queue.length > 0) {
        let p = queue.shift(), curr = p[p.length-1];
        if (curr.r === tr && curr.c === tc) return p;
        for (let n of [{r:0,c:1},{r:0,c:-1},{r:1,c:0},{r:-1,c:0}]) {
            let nr = curr.r+n.r, nc = curr.c+n.c;
            if (nr>=0 && nr<rows && nc>=0 && nc<cols && cityMap[nr][nc]!==1 && !visited.has(`${nr},${nc}`)) {
                visited.add(`${nr},${nc}`); queue.push([...p, {r: nr, c: nc}]);
            }
        }
    } return [];
}

canvas.onclick = (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    selectedCall = calls.find(c => Math.hypot(c.x-x, c.y-y) < 30) || null;
};

function dispatchAll() {
    if (!selectedCall) return;
    units.forEach(u => { 
        u.target = selectedCall; 
        if (u.type !== 'air') {
            u.path = findPath(Math.floor(u.y/tileSize), Math.floor(u.x/tileSize), Math.floor(selectedCall.y/tileSize), Math.floor(selectedCall.x/tileSize));
        }
    });
    playRadio(`Dispatch: Units responding to ${selectedCall.type} call.`);
}

function buy(t) {
    let p = {crown:300, explorer:500, tahoe:800, pierce:2500, air:1500}[t];
    if (money >= p) { money -= p; units.push(new Unit(t)); }
}

function playRadio(m) {
    let log = document.getElementById('radio-log');
    log.innerHTML = `<div>[RADIO] ${m}</div>` + log.innerHTML;
}

function gameLoop() {
    frames++; ctx.clearRect(0, 0, 800, 500);
    for(let r=0; r<rows; r++) {
        for(let c=0; c<cols; c++) {
            ctx.fillStyle = cityMap[r][c] === 1 ? '#1a1a1a' : (cityMap[r][c] === 2 ? '#2c3e50' : '#333');
            ctx.fillRect(c*tileSize, r*tileSize, tileSize, tileSize);
        }
    }
    if (frames % 400 === 0) calls.push(new Call('standard'));
    if (frames % 1200 === 0) calls.push(new Call('high'));
    if (frames % 800 === 0) calls.push(new Call('moving'));
    calls.forEach(c => { c.update(); c.draw(); });
    units.forEach(u => { u.update(); u.draw(); });
    document.getElementById('money').innerText = Math.floor(money);
    document.getElementById('fleet-count').innerText = units.length;
    requestAnimationFrame(gameLoop);
}
units.push(new Unit('explorer')); gameLoop();
</script>
</body>
</html>

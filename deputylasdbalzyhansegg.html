<!DOCTYPE html>
<html>
<head>
    <title>Mass Dispatch Command</title>
    <style>
        body { background: #111; color: white; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #game-container { position: relative; display: flex; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        canvas { background: #1e272e; border: 4px solid #f1c40f; border-radius: 8px; }
        .ui-top { position: absolute; top: -50px; width: 800px; display: flex; justify-content: space-between; font-size: 22px; font-weight: bold; color: #f1c40f; }
        #side-panel { width: 250px; background: #2c3e50; padding: 20px; border-left: 4px solid #f1c40f; height: 500px; }
        .unit-card { background: #34495e; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 5px solid #f1c40f; cursor: pointer; font-size: 14px; }
        .btn-dispatch { background: #e67e22; border: none; color: white; padding: 12px; width: 100%; border-radius: 5px; cursor: pointer; margin-top: 15px; font-weight: bold; }
        #radio-log { position: absolute; bottom: 20px; left: 20px; width: 280px; height: 80px; background: rgba(0,0,0,0.8); border-radius: 5px; padding: 10px; font-size: 11px; color: #2ecc71; pointer-events: none; }
        #speedometer { position: absolute; bottom: 20px; right: 280px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 50%; border: 2px solid #f1c40f; width: 80px; height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; visibility: hidden; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="ui-top">
        <span>ðŸ’° $<span id="money">1000</span></span>
        <span>ðŸš” Fleet: <span id="fleet-count">1</span></span>
    </div>

    <canvas id="cityCanvas" width="800" height="500"></canvas>

    <div id="speedometer">
        <span id="speed-val">0</span>
        <span style="font-size:10px">MPH</span>
    </div>

    <div id="side-panel">
        <h3 style="margin-top:0; border-bottom: 1px solid #f1c40f;">FLEET</h3>
        <div class="unit-card" onclick="buy('crown')">Crown Vic ($300)</div>
        <div class="unit-card" onclick="buy('explorer')">Explorer ($500)</div>
        <div class="unit-card" onclick="buy('tahoe')">Tahoe ($800)</div>
        <div class="unit-card" onclick="buy('air')">Aero Bureau ($1500)</div>
        
        <button class="btn-dispatch" onclick="dispatchAllAvailable()">SEND ALL AVAILABLE</button>

        <p style="font-size:11px; color:#f1c40f; margin-top:20px;">
            - Click ðŸš¨ to select target.<br>
            - Use the button above to dispatch backup!<br>
        </p>
    </div>
    
    <div id="radio-log"></div>
</div>

<script>
const canvas = document.getElementById('cityCanvas');
const ctx = canvas.getContext('2d');
const tileSize = 50;
const cols = 16, rows = 10;

const cityMap = [
   [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
   [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
   [1,0,1,1,1,0,1,1,1,1,1,1,1,1,0,1],
   [1,0,1,0,0,0,1,0,0,0,0,0,0,1,0,1],
   [1,0,1,0,1,1,1,0,1,1,1,1,0,1,0,1],
   [1,0,1,0,0,0,0,0,1,0,0,0,0,1,0,1],
   [1,0,1,1,1,1,1,1,1,0,1,1,1,1,0,1],
   [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
   [1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
   [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

let money = 1000, units = [], crimes = [], frames = 0;
let selectedCrimeForBackup = null; // New variable to track the selected crime

// ... (Keep existing class definitions for Unit and Crime, they are fine)

class Unit {
    // ... (Keep the update and draw methods from v9, they are fine)
    constructor(type) {
        this.type = type;
        this.x = 3 * tileSize + 25; this.y = 3 * tileSize + 25;
        this.angle = 0; this.speed = 0;
        this.maxSpeed = (type === 'air') ? 6 : 4.5;
        this.targetCrime = null;
    }
    update() {
        // Simplified driving for this version (removed manual WASD to focus on dispatch system)
        if (this.targetCrime) {
            let dx = this.targetCrime.x - this.x, dy = this.targetCrime.y - this.y, dist = Math.hypot(dx, dy);
            if (dist < 30) {
                this.speed *= 0.8;
                this.targetCrime.progress += 0.5;
                if (this.targetCrime.progress >= 100) {
                    money += 500; crimes = crimes.filter(c => c !== this.targetCrime);
                    units.forEach(u => { if(u.targetCrime === this.targetCrime) u.targetCrime = null; });
                    playRadio("Code 4. Suspect in custody.");
                }
            } else { this.angle = Math.atan2(dy, dx); this.speed += 0.15; }
        }
        this.speed *= 0.95;
        let vx = Math.cos(this.angle) * this.speed, vy = Math.sin(this.angle) * this.speed;
        if (this.type === 'air' || canPass(this.x + vx, this.y + vy)) { this.x += vx; this.y += vy; } else { this.speed *= -0.5; }
    }
    draw() {
        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
        ctx.fillStyle = this.type === 'air' ? '#f1c40f' : 'black';
        ctx.fillRect(-15, -8, 30, 16);
        ctx.fillStyle = 'white'; ctx.fillRect(-10, -6, 10, 12);
        if (Math.abs(this.speed) > 0.2 || this.targetCrime) { ctx.fillStyle = (frames % 10 < 5) ? 'red' : 'blue'; ctx.fillRect(8, -8, 6, 6); }
        ctx.restore();
    }
}

class Crime {
    // ... (Keep the Crime class from v9, it is fine)
    constructor() {
        let r, c;
        do { r = Math.floor(Math.random() * rows); c = Math.floor(Math.random() * cols); } while (cityMap[r][c] !== 0);
        this.x = c * tileSize + 25; this.y = r * tileSize + 25;
        this.progress = 0; this.assigned = false;
    }
    draw() {
        // Highlight selected crime with a pulsing ring
        if(selectedCrimeForBackup === this) {
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 4;
            ctx.globalAlpha = Math.sin(frames * 0.1) * 0.5 + 0.5;
            ctx.beginPath(); ctx.arc(this.x, this.y, 20, 0, Math.PI * 2); ctx.stroke();
            ctx.globalAlpha = 1.0;
        }
        ctx.fillStyle = this.assigned ? '#e67e22' : '#e74c3c';
        ctx.beginPath(); ctx.arc(this.x, this.y, 12, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'white'; ctx.fillRect(this.x-10, this.y+15, 20, 4);
        ctx.fillStyle = '#2ecc71'; ctx.fillRect(this.x-10, this.y+15, (this.progress/100)*20, 4);
    }
}


function canPass(x, y) {
    let gx = Math.floor(x / tileSize), gy = Math.floor(y / tileSize);
    return cityMap[gy] && cityMap[gy][gx] !== 1;
}

// *** NEW DISPATCH ALL FUNCTION ***
function dispatchAllAvailable() {
    if (!selectedCrimeForBackup) {
        playRadio("Dispatch: Select a crime icon first!");
        return;
    }
    let idleUnits = units.filter(u => !u.targetCrime);
    if (idleUnits.length === 0) {
        playRadio("Dispatch: All units are busy!");
        return;
    }

    idleUnits.forEach(unit => {
        unit.targetCrime = selectedCrimeForBackup;
    });
    playRadio(`Dispatch: Sending ${idleUnits.length} units to selected location!`);
    selectedCrimeForBackup.assigned = true;
}


canvas.onclick = (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;

    let clickedCrime = crimes.find(c => Math.hypot(c.x - x, c.y - y) < 25);

    if (clickedCrime) {
        selectedCrimeForBackup = clickedCrime; // Just select the crime, don't auto-dispatch immediately
        playRadio("Crime selected for backup operations.");
    } else {
        selectedCrimeForBackup = null; // Deselect if you click empty space
    }
};

function buy(type) {
    let p = {crown:300, explorer:500, tahoe:800, air:1500}[type];
    if (money >= p) { money -= p; units.push(new Unit(type)); document.getElementById('fleet-count').innerText = units.length; }
}

function playRadio(m) {
    let log = document.getElementById('radio-log');
    log.innerHTML = `<div>[RADIO] ${m}</div>` + log.innerHTML;
}

function gameLoop() {
    frames++; ctx.clearRect(0, 0, 800, 500);
    
    for(let r=0; r<rows; r++) {
        for(let c=0; c<cols; c++) {
            ctx.fillStyle = cityMap[r][c] === 1 ? '#2c3e50' : (cityMap[r][c] === 2 ? '#27ae60' : '#7f8c8d');
            ctx.fillRect(c*tileSize, r*tileSize, tileSize, tileSize);
            ctx.strokeStyle = '#333'; ctx.strokeRect(c*tileSize, r*tileSize, tileSize, tileSize);
        }
    }

    if (frames % 500 === 0) crimes.push(new Crime());

    crimes.forEach(c => c.draw());
    units.forEach(u => { u.update(); u.draw(); });

    document.getElementById('money').innerText = Math.floor(money);
    requestAnimationFrame(gameLoop);
}

units.push(new Unit('explorer'));
gameLoop();
</script>
</body>
</html>

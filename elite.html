<!DOCTYPE html>
<html>
<head>
    <title>LASD: Elite Fleet DTLA v15</title>
    <style>
        body { background: #000; color: white; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #game-container { position: relative; display: flex; border: 4px solid #444; }
        canvas { background: #111; cursor: pointer; }
        .ui-top { position: absolute; top: -50px; width: 800px; display: flex; justify-content: space-between; font-size: 24px; font-weight: bold; color: #f1c40f; }
        #side-panel { width: 250px; background: #222; padding: 20px; border-left: 4px solid #f1c40f; height: 500px; overflow-y: auto; }
        .unit-card { background: #333; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 5px solid #f1c40f; cursor: pointer; font-size: 12px; }
        .btn-dispatch { background: #d35400; border: none; color: white; padding: 12px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        #radio-log { position: absolute; bottom: 20px; left: 20px; width: 280px; height: 80px; background: rgba(0,0,0,0.8); padding: 10px; font-size: 11px; color: #2ecc71; pointer-events: none; border-radius: 5px; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="ui-top">
        <span>ðŸ’° $<span id="money">1000</span></span>
        <span>ðŸš” Units: <span id="fleet-count">1</span></span>
    </div>
    <canvas id="cityCanvas" width="800" height="500"></canvas>
    <div id="side-panel">
        <h3 style="margin-top:0; color:#f1c40f;">DISPATCH CENTER</h3>
        <button class="btn-dispatch" onclick="dispatchNearest()" style="background:#2980b9">DISPATCH NEAREST</button>
        <button class="btn-dispatch" onclick="dispatchAll()">DISPATCH ALL UNITS</button>
        
        <h3 style="color:#f1c40f; font-size: 16px;">FLEET SHOP</h3>
        <div class="unit-card" onclick="buy('crown')"><b>Crown Vic</b><br>Classic Patrol ($300)</div>
        <div class="unit-card" onclick="buy('explorer')"><b>Explorer Utility</b><br>Modern SUV ($500)</div>
        <div class="unit-card" onclick="buy('tahoe')"><b>Tahoe Interceptor</b><br>Heavy Duty ($800)</div>
        <div class="unit-card" onclick="buy('pierce')"><b>Pierce Command</b><br>Mobile HQ ($2500)</div>
        <div class="unit-card" onclick="buy('air')"><b>Aero Bureau</b><br>Helicopter ($1500)</div>
    </div>
    <div id="radio-log"></div>
</div>

<script>
const canvas = document.getElementById('cityCanvas');
const ctx = canvas.getContext('2d');
const tileSize = 25, cols = 32, rows = 20;

const cityMap = Array.from({length: rows}, (_, r) => 
    Array.from({length: cols}, (_, c) => {
        if (r % 5 === 0 || r % 5 === 1 || c % 8 === 0 || c % 8 === 1) return 0;
        if (r > 8 && r < 12 && c > 14 && c < 18) return 2;
        return 1;
    })
);

let money = 1000, units = [], calls = [], frames = 0, selectedCall = null;

class Unit {
    constructor(type) {
        this.type = type;
        this.x = 16 * tileSize + 12; this.y = 10 * tileSize + 12;
        this.speed = (type === 'air') ? 4.5 : (type === 'pierce' ? 1.5 : 3.5);
        this.path = []; this.target = null;
    }
    update() {
        if (this.target) {
            let dx = this.target.x - this.x, dy = this.target.y - this.y, dist = Math.hypot(dx, dy);
            if (this.type === 'air') {
                if (dist > 10) { this.x += (dx/dist)*this.speed; this.y += (dy/dist)*this.speed; }
            } else {
                if ((this.target.isMoving && frames % 60 === 0) || (this.path.length === 0 && dist > 50)) this.recalculatePath();
                if (this.path.length > 0) {
                    let next = this.path;
                    let tx = next.c * tileSize + 12, ty = next.r * tileSize + 12;
                    let dnx = tx - this.x, dny = ty - this.y, ddist = Math.hypot(dnx, dny);
                    if (ddist < 10) this.path.shift();
                    else { this.x += (dnx/ddist)*this.speed; this.y += (dny/ddist)*this.speed; }
                }
            }
            if (dist < 45) {
                this.target.progress += (this.type === 'pierce' ? 1.5 : 0.5) / (this.target.type === 'high' ? 4 : 1);
                if (this.target.progress >= 100) {
                    money += this.target.type === 'high' ? 2500 : 600;
                    calls = calls.filter(c => c !== this.target);
                    units.forEach(u => { if(u.target === this.target) u.target = null; });
                    playRadio(`Code 4 at location.`);
                }
            }
        }
    }
    recalculatePath() {
        if (!this.target) return;
        const newPath = findPath(Math.floor(this.y/tileSize), Math.floor(this.x/tileSize), Math.floor(this.target.y/tileSize), Math.floor(this.target.x/tileSize));
        if (newPath.length > 0) this.path = newPath;
    }
    draw() {
        ctx.save(); ctx.translate(this.x, this.y);
        if(this.target) ctx.rotate(Math.atan2(this.target.y - this.y, this.target.x - this.x));
        
        // --- DETAILED VISUALS & FLASHING LIGHTS ---
        if (this.type === 'air') { 
            ctx.fillStyle = '#f1c40f'; ctx.fillRect(-18, -6, 36, 12); // Heli body
            ctx.fillStyle = '#333'; ctx.fillRect(-2, -20, 4, 40); // Rotor blade
        } else if (this.type === 'pierce') {
            ctx.fillStyle = '#fff'; ctx.fillRect(-20, -10, 40, 20); // Command center body
            ctx.fillStyle = '#c0392b'; ctx.fillRect(15, -10, 5, 20); // Red stripe
        } else {
            ctx.fillStyle = '#000'; ctx.fillRect(-15, -8, 30, 16); // Standard black car body
            ctx.fillStyle = '#fff'; ctx.fillRect(-10, -6, 10, 12); // White door
        }
        
        // Flashing lights logic (only when responding)
        if (this.target) {
            if (frames % 20 < 10) { ctx.fillStyle = 'red'; ctx.fillRect(10, -8, 6, 6); } // Red light
            else { ctx.fillStyle = 'blue'; ctx.fillRect(10, -8, 6, 6); } // Blue light
        }
        // --- END VISUALS ---
        
        ctx.restore();
    }
}

class Call {
    constructor(type) {
        this.type = type;
        let r, c; do { r = Math.floor(Math.random()*rows); c = Math.floor(Math.random()*cols); } while(cityMap[r][c] !== 0);
        this.x = c * tileSize + 12; this.y = r * tileSize + 12;
        this.progress = 0; this.isMoving = type === 'moving';
        this.dir = {r: 0, c: 1};
    }
    update() {
        if (this.isMoving && frames % 2 === 0) {
            let nx = this.x + this.dir.c*1.5, ny = this.y + this.dir.r*1.5;
            let gr = Math.floor(ny/tileSize), gc = Math.floor(nx/tileSize);
            if (cityMap[gr] && cityMap[gr][gc] === 0) { this.x = nx; this.y = ny; }
            else { this.dir = [{r:0,c:1},{r:0,c:-1},{r:1,c:0},{r:-1,c:0}][Math.floor(Math.random()*4)]; }
        }
    }
    draw() {
        ctx.fillStyle = this.type === 'high' ? '#9b59b6' : (this.type === 'moving' ? '#e74c3c' : '#3498db');
        ctx.beginPath(); ctx.arc(this.x, this.y, 10, 0, Math.PI*2); ctx.fill();
        if(selectedCall === this) { ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.stroke(); }
        ctx.fillStyle = '#2ecc71'; ctx.fillRect(this.x-15, this.y+15, (this.progress/100)*30, 5);
    }
}

function findPath(sr, sc, tr, tc) {
    // ... (Keep existing findPath function from v14) ...
    if (sr < 0 || sr >= rows || sc < 0 || sc >= cols) return [];
    let queue = [[{r: sr, c: sc}]], visited = new Set([`${sr},${sc}`]);
    while (queue.length > 0) {
        let p = queue.shift(), curr = p[p.length-1];
        if (curr.r === tr && curr.c === tc) return p;
        for (let n of [{r:0,c:1},{r:0,c:-1},{r:1,c:0},{r:-1,c:0}]) {
            let nr = curr.r+n.r, nc = curr.c+n.c;
            if (nr>=0 && nr<rows && nc>=0 && nc<cols && cityMap[nr][nc]!==1 && !visited.has(`${nr},${nc}`)) {
                visited.add(`${nr},${nc}`); queue.push([...p, {r: nr, c: nc}]);
            }
        }
    } return [];
}

canvas.onclick = (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    selectedCall = calls.find(c => Math.hypot(c.x - x, c.y - y) < 40) || null;
};

function dispatchNearest() {
    if (!selectedCall) return;
    let available = units.filter(u => !u.target);
    if (!available.length) return;
    available.sort((a,b) => Math.hypot(a.x-selectedCall.x, a.y-selectedCall.y) - Math.hypot(b.x-selectedCall.x, b.y-selectedCall.y));
    let u = available;
    u.target = selectedCall;
    if (u.type !== 'air') u.recalculatePath();
}
function dispatchAll() {
    if (!selectedCall) return;
    units.forEach(u => { u.target = selectedCall; if (u.type !== 'air') u.recalculatePath(); });
}
function buy(t) {
    let p = {crown:300, explorer:500, tahoe:800, pierce:2500, air:1500}[t];
    if (money >= p) { money -= p; units.push(new Unit(t)); }
}
function playRadio(m) {
    let log = document.getElementById('radio-log');
    log.innerHTML = `<div>[RADIO] ${m}</div>` + log.innerHTML;
}
function gameLoop() {
    frames++; ctx.clearRect(0, 0, 800, 500);
    for(let r=0; r<rows; r++) {
        for(let c=0; c<cols; c++) {
            ctx.fillStyle = cityMap[r][c] === 1 ? '#1a1a1a' : (cityMap[r][c] === 2 ? '#2c3e50' : '#333');
            ctx.fillRect(c*tileSize, r*tileSize, tileSize, tileSize);
        }
    }
    if (frames % 400 === 0) calls.push(new Call('standard'));
    if (frames % 1200 === 0) calls.push(new Call('high'));
    if (frames % 800 === 0) calls.push(new Call('moving'));
    calls.forEach(c => { c.update(); c.draw(); });
    units.forEach(u => { u.update(); u.draw(); });
    document.getElementById('money').innerText = Math.floor(money);
    document.getElementById('fleet-count').innerText = units.length;
    requestAnimationFrame(gameLoop);
}
units.push(new Unit('explorer')); gameLoop();
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>TD: Command Center</title>
    <style>
        body { background: #111; color: white; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #game-area { position: relative; display: none; }
        canvas { background: #1e272e; border: 4px solid #34495e; border-radius: 10px; cursor: crosshair; }
        .ui-top { position: absolute; top: -60px; width: 100%; display: flex; justify-content: space-between; font-size: 24px; font-weight: bold; color: #f1c40f; }
        #side-panel { position: absolute; right: -220px; top: 0; width: 200px; background: #2c3e50; padding: 15px; border-radius: 10px; border: 2px solid #3498db; }
        .btn { background: #3498db; border: none; color: white; padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .btn:hover { background: #2980b9; }
        .tower-selector-btn { display: block; width: 100%; padding: 10px; margin-bottom: 10px; text-align: left; font-size: 16px; }
        .tower-selector-btn.selected { border: 2px solid #f1c40f; background: #3e5871; }
        .tower-selector-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #menu { position: absolute; background: rgba(0,0,0,0.9); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; border-radius: 10px; }
    </style>
</head>
<body>

<div id="menu">
    <h1 style="color:#f1c40f; font-size: 40px;">COMMAND CENTER TD</h1>
    <p>Use the panel on the right to select and place towers.</p>
    <button class="btn" style="width:200px" onclick="startGame()">DEPLOY</button>
</div>

<div id="game-area">
    <div class="ui-top">
        <span>üí∞ <span id="gold">200</span></span>
        <span>‚ù§Ô∏è <span id="lives">20</span></span>
        <span>üåä <span id="wave">1</span></span>
    </div>

    <canvas id="gameCanvas" width="800" height="500"></canvas>

    <div id="side-panel">
        <h3>Build Menu</h3>
        <button id="btn-basic" class="tower-selector-btn selected" onclick="selectTower('basic')">Cannon (50g) üß±</button>
        <button id="btn-ice" class="tower-selector-btn" onclick="selectTower('ice')">Ice Gun (100g) üßä</button>
        <button id="btn-aa" class="tower-selector-btn" onclick="selectTower('aa')">Anti-Air (150g) ‚úàÔ∏è</button>
        
        <div style="margin-top:20px; border-top: 1px solid #444; padding-top: 10px;">
            <p>Selected Tower Level: <span id="up-lvl">N/A</span></p>
            <button id="up-btn" class="btn" onclick="upgradeSelectedTower()">Upgrade (100g)</button>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let gold, lives, wave, frames, gameActive = false, selectedTower = null, buildType = 'basic';
let enemies = [], towers = [], projectiles = [];

const path = [{x: 0, y: 250}, {x: 200, y: 250}, {x: 200, y: 100}, {x: 600, y: 100}, {x: 600, y: 400}, {x: 800, y: 400}];

class Enemy {
    constructor(type = 'land') {
        this.type = type;
        this.x = path.x; this.y = path.y;
        this.health = (type === 'boss' ? 300 : type === 'air' ? 15 : 20) * (1 + wave*0.2);
        this.maxHealth = this.health;
        this.speed = (type === 'air' ? 2 : type === 'boss' ? 0.6 : 1.2);
        this.pathIndex = 0; this.slowTimer = 0; this.radius = (type==='boss'?25:12);
    }
    update() {
        let s = this.slowTimer > 0 ? this.speed * 0.5 : this.speed;
        if (this.slowTimer > 0) this.slowTimer--;
        if (this.type === 'air') this.x += s; 
        else {
            let target = path[this.pathIndex + 1];
            if (target) { let dx = target.x - this.x, dy = target.y - this.y, dist = Math.hypot(dx, dy);
                if (dist < s) this.pathIndex++;
                else { this.x += (dx/dist)*s; this.y += (dy/dist)*s; }
            }
        }
        if (this.x > 800) { lives -= (this.type==='boss'?10:1); this.health = 0; }
    }
    draw() {
        ctx.fillStyle = this.type === 'air' ? '#f1c40f' : (this.type === 'boss' ? '#9b59b6' : '#e74c3c');
        ctx.beginPath();
        if(this.type === 'air') ctx.rect(this.x-10, this.y-10, 20, 10);
        else ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
        ctx.fill();
    }
}

class Tower {
    constructor(x, y, type) {
        this.x = x; this.y = y; this.type = type; this.lvl = 1; this.timer = 0;
        this.range = type === 'aa' ? 250 : 150;
        this.damage = type === 'ice' ? 2 : (type==='aa'?5:10);
    }
    update() {
        this.timer++;
        if (this.timer >= (30 - this.lvl*2)) {
            let targets = enemies.filter(e => Math.hypot(e.x - this.x, e.y - this.y) < this.range);
            if (this.type === 'aa') targets = targets.filter(e => e.type === 'air');
            else targets = targets.filter(e => e.type !== 'air');
            
            if (targets.length) {
                targets.sort((a, b) => b.health - a.health); // Strongest Target Priority
                projectiles.push(new Projectile(this.x, this.y, targets, this.type, this.damage * (1 + this.lvl*0.5)));
                this.timer = 0;
            }
        }
    }
    draw() {
        ctx.fillStyle = this.type==='ice'?'#00ffff':(this.type==='aa'?'#f1c40f':'#95a5a6'); // Realistic colors
        ctx.fillRect(this.x-15, this.y-15, 30, 30);
        ctx.fillStyle = "black"; ctx.fillText("L"+this.lvl, this.x-8, this.y+5);
    }
}

class Projectile {
    constructor(x, y, target, type, dmg) {
        this.x = x; this.y = y; this.target = target; this.type = type; this.dmg = dmg; this.speed = 10;
    }
    update() {
        let dx = this.target.x - this.x, dy = this.target.y - this.y;
        let dist = Math.hypot(dx, dy);
        if (dist < 10) {
            this.target.health -= this.dmg;
            if (this.type === 'ice') this.target.slowTimer = 90;
            this.dead = true;
        } else { this.x += (dx/dist)*this.speed; this.y += (dy/dist)*this.speed; }
    }
    draw() {
        ctx.fillStyle = this.type === 'aa' ? 'red' : 'white';
        ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill();
    }
}

// UI & Controls
function selectTower(type) {
    buildType = type;
    document.querySelectorAll('.tower-selector-btn').forEach(btn => btn.classList.remove('selected'));
    document.getElementById(`btn-${type}`).classList.add('selected');
}

canvas.onclick = (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    
    // Check if clicking existing tower for upgrade menu
    let clicked = towers.find(t => Math.hypot(t.x - x, t.y - y) < 20);
    if (clicked) { showUpgradePanel(clicked); return; }

    const cost = {basic: 50, ice: 100, aa: 150}[buildType];
    if (gold >= cost) { towers.push(new Tower(x, y, buildType)); gold -= cost; }
};

function showUpgradePanel(t) {
    selectedTower = t;
    document.getElementById('up-lvl').innerText = t.lvl;
    const cost = t.lvl * 100;
    document.getElementById('up-btn').innerText = `Upgrade (${cost}g)`;
    document.getElementById('up-btn').disabled = gold < cost;
}

function upgradeSelectedTower() {
    if (selectedTower) {
        const cost = selectedTower.lvl * 100;
        if (gold >= cost) {
            gold -= cost;
            selectedTower.lvl++;
            showUpgradePanel(selectedTower);
        }
    }
}

function startGame() {
    gold = 200; lives = 20; wave = 1; frames = 0; gameActive = true;
    enemies = []; towers = []; projectiles = [];
    document.getElementById('menu').style.display = 'none';
    document.getElementById('game-area').style.display = 'block';
    gameLoop();
}

function gameLoop() {
    if (!gameActive) return;
    frames++;
    ctx.clearRect(0, 0, 800, 500);

    ctx.strokeStyle = '#2f3640'; ctx.lineWidth = 40; ctx.beginPath();
    ctx.moveTo(path.x, path.y); path.forEach(p => ctx.lineTo(p.x, p.y)); ctx.stroke();

    if (frames % 100 === 0) enemies.push(new Enemy(wave % 5 === 0 ? 'boss' : 'land'));
    if (frames % 300 === 0 && wave > 2) enemies.push(new Enemy('air'));
    if (frames % 1500 === 0) wave++;

    towers.forEach(t => t.update());
    towers.forEach(t => t.draw());
    projectiles.forEach((p, i) => { p.update(); p.draw(); if(p.dead || p.target.health <= 0) projectiles.splice(i, 1); });
    enemies.forEach((e, i) => { 
        e.update(); e.draw(); 
        if(e.health <= 0) { if(e.x < 800) gold += (e.type==='boss'?100:15); enemies.splice(i, 1); }
    });

    document.getElementById('gold').innerText = gold;
    document.getElementById('lives').innerText = lives;
    document.getElementById('wave').innerText = wave;
    document.getElementById('up-btn').disabled = selectedTower && gold < selectedTower.lvl * 100;


    if (lives > 0) requestAnimationFrame(gameLoop);
    else alert("GAME OVER - Wave " + wave);
}
</script>
</body>
</html>

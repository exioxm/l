<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nitro Racer: Apex Protocol v3.1</title>
    <style>
        @import url('fonts.googleapis.com');
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Orbitron', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        #game-container { position: relative; width: 440px; height: 750px; background: #020205; border: 4px solid #ff0044; box-shadow: 0 0 80px rgba(255, 0, 68, 0.4); border-radius: 15px; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; border-radius: 12px; }
        
        #ui, .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff; z-index: 10; }
        #ui { justify-content: flex-start; padding-top: 25px; visibility: hidden; }
        .overlay { pointer-events: auto; background: rgba(1, 1, 5, 0.98); backdrop-filter: blur(20px); }
        .hidden { display: none !important; }
        
        .stat-row { width: 92%; display: flex; justify-content: space-between; background: linear-gradient(90deg, rgba(255,0,68,0.15), rgba(0,0,0,0)); padding: 15px; border-left: 4px solid #ff0044; box-sizing: border-box; }
        .label { font-size: 10px; color: #ff0044; text-transform: uppercase; letter-spacing: 3px; }
        .val { font-size: 26px; font-weight: 900; text-shadow: 0 0 15px #ff0044; }
        
        h1 { font-size: 38px; font-weight: 900; color: #ff0044; text-shadow: 0 0 30px #ff0044; margin: 0; letter-spacing: -2px; text-transform: uppercase; }
        .btn { width: 280px; padding: 16px; margin: 8px; background: #000; border: 2px solid #ff0044; color: #ff0044; font-weight: 900; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 2px; }
        .btn:hover { background: #ff0044; color: #000; box-shadow: 0 0 40px #ff0044; transform: scale(1.02); }

        /* FIXED GARAGE UI */
        #garage { justify-content: flex-start; padding-top: 40px; }
        .preview-box { background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 10px; margin-bottom: 20px; }
        .car-scroll-wrapper { width: 100%; overflow-x: auto; padding: 10px 0; display: flex; scroll-behavior: smooth; }
        .car-scroll-wrapper::-webkit-scrollbar { height: 5px; }
        .car-scroll-wrapper::-webkit-scrollbar-thumb { background: #ff0044; border-radius: 10px; }
        
        .car-card { 
            flex: 0 0 160px; height: 120px; margin: 0 10px; background: rgba(255,255,255,0.05); 
            border: 1px solid #444; border-radius: 10px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .car-card.selected { border-color: #ff0044; background: rgba(255,0,68,0.2); box-shadow: 0 0 15px #ff0044; }
        .car-card h3 { margin: 5px 0; font-size: 14px; pointer-events: none; }
        .car-card span { font-size: 12px; color: #ffcc00; pointer-events: none; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui">
        <div class="stat-row">
            <div><div class="label">Velocity</div><div class="val" id="speedDisp">0</div></div>
            <div><div class="label">Wallet</div><div class="val" id="creditsUI">0</div></div>
        </div>
        <div id="wanted" style="margin-top:15px; letter-spacing: 5px; text-align:center; font-size: 22px;"></div>
    </div>

    <div id="menu" class="overlay">
        <p style="color:#ff0044; letter-spacing: 5px; margin-bottom: 5px;">APEX PROTOCOL 2025</p>
        <h1>NITRO RACER</h1>
        <div style="color:#ffcc00; margin: 20px 0; font-size: 18px;">$ <span id="crMenu">0</span></div>
        <button class="btn" onclick="startGame('NORMAL')">Start Grid</button>
        <button class="btn" style="border-color:#ffaa00; color:#ffaa00;" onclick="startGame('PURSUIT')">Cyber Pursuit</button>
        <button class="btn" style="border-color:#00ff88; color:#00ff88;" onclick="openPanel('garage')">Garage</button>
    </div>

    <div id="garage" class="overlay hidden">
        <h1>GARAGE</h1>
        <div class="preview-box">
            <canvas id="carPreviewCanvas" width="120" height="200"></canvas>
        </div>
        <div class="car-scroll-wrapper" id="carGrid"></div>
        <button class="btn" style="margin-top:20px;" onclick="openPanel('menu')">Confirm & Back</button>
    </div>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 440; canvas.height = 750;
    const ptx = document.getElementById("carPreviewCanvas").getContext("2d");

    const VERSION = "3.1";
    let credits = parseInt(localStorage.getItem('nitroCr')) || 2500;
    let unlockedCars = JSON.parse(localStorage.getItem('nitroCars')) || ['Specter'];
    let currentCar = localStorage.getItem('nitroActiveCar') || 'Specter';
    let gameState = 'MENU', gameMode = 'NORMAL', score = 0, speed = 0, frames = 0, wantedLevel = 0;
    let enemies = [], keys = {};
    let p1 = { x: 190, y: 600, alive: true };

    const carData = {
        'Specter': { w: 42, h: 84, price: 0, color: '#00f2ff' },
        'Interceptor': { w: 38, h: 90, price: 5000, color: '#ff0044' },
        'Goliath': { w: 56, h: 88, price: 12000, color: '#00ff88' },
        'Venom': { w: 40, h: 95, price: 25000, color: '#ffff00' },
        'Hyperion': { w: 44, h: 100, price: 50000, color: '#ff00ff' }
    };

    const enemyData = {
        'POLICE': { w: 40, h: 85, color: '#ff0044' },
        'SWAT': { w: 75, h: 115, color: '#ffffff' },
        'TANK': { w: 95, h: 140, color: '#ffaa00' }
    };

    window.addEventListener("keydown", (e) => keys[e.code] = true);
    window.addEventListener("keyup", (e) => keys[e.code] = false);

    function openPanel(id) {
        document.querySelectorAll('.overlay').forEach(p => p.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'garage') { renderGarage(); drawPreview(); }
        updateCurrencyUI();
    }

    function updateCurrencyUI() {
        document.getElementById('crMenu').innerText = credits.toLocaleString();
        document.getElementById('creditsUI').innerText = credits.toLocaleString();
    }

    let angle = 0;
    function drawPreview() {
        if(document.getElementById('garage').classList.contains('hidden')) return;
        ptx.clearRect(0,0,120,200);
        ptx.save();
        ptx.translate(60, 100);
        ptx.rotate(angle);
        angle += 0.02;
        const d = carData[currentCar];
        ptx.fillStyle = "#000"; ptx.fillRect(-d.w/2, -d.h/2, d.w, d.h);
        ptx.strokeStyle = d.color; ptx.lineWidth = 3; ptx.strokeRect(-d.w/2, -d.h/2, d.w, d.h);
        ptx.restore();
        requestAnimationFrame(drawPreview);
    }

    function renderGarage() {
        const grid = document.getElementById('carGrid'); grid.innerHTML = '';
        for(let name in carData) {
            const isOwned = unlockedCars.includes(name);
            const card = document.createElement('div');
            card.className = `car-card ${currentCar === name ? 'selected' : ''}`;
            card.innerHTML = `<h3>${name}</h3><span>${isOwned ? 'OWNED' : '$'+carData[name].price}</span>`;
            card.onclick = () => {
                if(isOwned) { currentCar = name; }
                else if(credits >= carData[name].price) {
                    credits -= carData[name].price; unlockedCars.push(name); currentCar = name;
                }
                localStorage.setItem('nitroCr', credits);
                localStorage.setItem('nitroCars', JSON.stringify(unlockedCars));
                localStorage.setItem('nitroActiveCar', currentCar);
                renderGarage();
            };
            grid.appendChild(card);
        }
    }

    function startGame(mode) {
        gameState = 'PLAY'; gameMode = mode;
        score = 0; speed = 10; enemies = []; frames = 0;
        p1 = { x: 190, y: 600, alive: true };
        document.querySelectorAll('.overlay').forEach(p => p.classList.add('hidden'));
        document.getElementById('ui').style.visibility = 'visible';
        gameLoop();
    }

    function gameLoop() {
        if(gameState !== 'PLAY') return;
        frames++; score++; speed += 0.003;
        const d = carData[currentCar];

        if(keys['ArrowLeft'] && p1.x > 40) p1.x -= 8;
        if(keys['ArrowRight'] && p1.x < 400 - d.w) p1.x += 8;

        wantedLevel = gameMode === 'PURSUIT' ? Math.min(6, Math.floor(score / 1500)) : 0;

        if(frames % 45 === 0) {
            let type = (gameMode === 'PURSUIT' && Math.random() > 0.3) ? (wantedLevel >= 5 ? 'TANK' : (wantedLevel >= 3 ? 'SWAT' : 'POLICE')) : 'CIV';
            enemies.push({ x: 60 + Math.floor(Math.random()*4)*85, y: -150, type, v: 2 + Math.random()*2 });
        }

        enemies.forEach((e, i) => {
            e.y += (speed - e.v);
            const ed = enemyData[e.type] || { w: 40, h: 80, color: '#333' };
            if(p1.alive && p1.x < e.x + ed.w && p1.x + d.w > e.x && p1.y < e.y + ed.h && p1.y + d.h > e.y) {
                gameState = 'MENU';
                credits += Math.floor(score/10);
                localStorage.setItem('nitroCr', credits);
                document.getElementById('ui').style.visibility = 'hidden';
                openPanel('menu');
            }
            if(e.y > 800) enemies.splice(i, 1);
        });

        // Draw Road
        ctx.fillStyle = "#010103"; ctx.fillRect(0,0,440,750);
        ctx.strokeStyle = "rgba(255, 255, 255, 0.05)";
        for(let i=0; i<12; i++) {
            let gy = (frames*speed + i*80) % 960;
            ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(440, gy); ctx.stroke();
        }

        // Draw Player
        ctx.fillStyle = "#000"; ctx.fillRect(p1.x, p1.y, d.w, d.h);
        ctx.strokeStyle = d.color; ctx.lineWidth = 3; ctx.strokeRect(p1.x, p1.y, d.w, d.h);

        // Draw Enemies
        enemies.forEach(e => {
            const ed = enemyData[e.type] || { w: 40, h: 80, color: '#333' };
            ctx.fillStyle = "#000"; ctx.fillRect(e.x, e.y, ed.w, ed.h);
            ctx.strokeStyle = ed.color; ctx.lineWidth = 2; ctx.strokeRect(e.x, e.y, ed.w, ed.h);
        });

        document.getElementById('wanted').innerHTML = '★'.repeat(wantedLevel).fontcolor('#ff0044') + '★'.repeat(Math.max(0, 5-wantedLevel)).fontcolor('#222');
        document.getElementById('speedDisp').innerText = Math.floor(speed * 20);
        updateCurrencyUI();
        requestAnimationFrame(gameLoop);
    }

    updateCurrencyUI();
</script>
</body>
</html>

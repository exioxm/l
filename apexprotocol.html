<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nitro Racer: Neon Overload v4.0</title>
    <style>
        @import url('fonts.googleapis.com');
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Orbitron', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        #game-container { position: relative; width: 440px; height: 750px; background: #010103; border: 2px solid #00f2ff; box-shadow: 0 0 50px rgba(0, 242, 255, 0.3); border-radius: 20px; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); z-index: 100; color: white; transition: 0.5s; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        
        /* Glassmorphism UI */
        #hud { position: absolute; top: 20px; width: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; z-index: 50; visibility: hidden; }
        .hud-glass { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 10px 20px; border-radius: 15px; display: flex; justify-content: space-between; width: 85%; }
        .hud-val { font-size: 24px; font-weight: 900; color: #00f2ff; text-shadow: 0 0 10px #00f2ff; }
        .hud-label { font-size: 10px; text-transform: uppercase; color: #888; }

        h1 { font-size: 45px; margin: 0; background: linear-gradient(to bottom, #fff, #00f2ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 20px #00f2ff); }
        .btn { width: 260px; padding: 18px; margin: 10px; background: transparent; border: 2px solid #00f2ff; color: #00f2ff; font-weight: 900; cursor: pointer; border-radius: 50px; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; }
        .btn:hover { background: #00f2ff; color: #000; box-shadow: 0 0 30px #00f2ff; transform: scale(1.05); }

        /* Garage Redesign */
        #garage-ui { padding: 20px; text-align: center; }
        .showroom { width: 150px; height: 250px; margin: 20px auto; background: radial-gradient(circle, rgba(0,242,255,0.2) 0%, transparent 70%); }
        .car-selector { display: flex; overflow-x: auto; width: 380px; gap: 15px; padding: 10px; border-top: 1px solid #333; }
        .car-item { flex: 0 0 120px; background: #111; padding: 15px; border-radius: 15px; border: 2px solid #333; cursor: pointer; }
        .car-item.active { border-color: #00f2ff; box-shadow: 0 0 15px #00f2ff; }

        #admin-btn { position: absolute; top: 10px; right: 10px; color: #222; cursor: pointer; font-size: 10px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="admin-btn" onclick="checkAdmin()">ADMIN</div>
    <canvas id="gameCanvas"></canvas>
    
    <!-- Gameplay HUD -->
    <div id="hud">
        <div class="hud-glass">
            <div><div class="hud-label">Speed</div><div class="hud-val" id="speedDisp">0</div></div>
            <div><div class="hud-label">Credits</div><div class="hud-val" id="creditsDisp">0</div></div>
        </div>
        <div id="wanted" style="margin-top:10px; font-size: 25px; letter-spacing: 5px;"></div>
    </div>

    <!-- Main Menu -->
    <div id="menu" class="overlay">
        <p style="letter-spacing: 8px; color: #555;">NEON OVERLOAD</p>
        <h1>NITRO RACER</h1>
        <p style="color: #ffcc00; margin: 20px;">WALLET: $<span id="wallet">0</span></p>
        <button class="btn" onclick="startGame('NORMAL')">Enter Grid</button>
        <button class="btn" style="border-color: #ff0044; color: #ff0044;" onclick="startGame('PURSUIT')">Hostile Pursuit</button>
        <button class="btn" style="border-color: #00ff88; color: #00ff88;" onclick="openPanel('garage-ui')">Garage</button>
    </div>

    <!-- Garage UI -->
    <div id="garage-ui" class="overlay hidden">
        <h1>SHOWROOM</h1>
        <div class="showroom"><canvas id="showroomCanvas" width="150" height="250"></canvas></div>
        <div class="car-selector" id="carList"></div>
        <button class="btn" style="margin-top:30px;" onclick="openPanel('menu')">Confirm</button>
    </div>

    <!-- Admin UI -->
    <div id="admin-panel" class="overlay hidden">
        <h1>OVERRIDE</h1>
        <button class="btn" style="border-color: red; color: red;" onclick="startGame('PURSUIT', true)">START @ 6 STARS</button>
        <button class="btn" onclick="addMoney()">+100K CREDITS</button>
        <button class="btn" onclick="openPanel('menu')">Exit</button>
    </div>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const sCanvas = document.getElementById("showroomCanvas");
    const sctx = sCanvas.getContext("2d");
    canvas.width = 440; canvas.height = 750;

    const VERSION = "4.0";
    let credits = parseInt(localStorage.getItem('nitroCr')) || 2500;
    let unlockedCars = JSON.parse(localStorage.getItem('nitroCars')) || ['Specter'];
    let currentCar = localStorage.getItem('nitroActiveCar') || 'Specter';
    let gameState = 'MENU', gameMode = 'NORMAL', score = 0, speed = 0, frames = 0, tilt = 0, shake = 0;
    let enemies = [], keys = {}, wantedLevel = 0;

    const carData = {
        'Specter': { w: 42, h: 84, color: '#00f2ff', price: 0 },
        'Venom': { w: 38, h: 90, color: '#ff0044', price: 5000 },
        'Titan': { w: 56, h: 90, color: '#00ff88', price: 15000 },
        'Hyperion': { w: 44, h: 100, color: '#ffff00', price: 40000 }
    };

    window.addEventListener("keydown", e => keys[e.code] = true);
    window.addEventListener("keyup", e => keys[e.code] = false);

    function checkAdmin() { if(prompt("CODE:") === "123") openPanel('admin-panel'); }
    function addMoney() { credits += 100000; updateUI(); }
    function openPanel(id) {
        document.querySelectorAll('.overlay').forEach(o => o.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'garage-ui') renderGarage();
    }

    function renderGarage() {
        const list = document.getElementById('carList');
        list.innerHTML = '';
        for(let name in carData) {
            const div = document.createElement('div');
            div.className = `car-item ${currentCar === name ? 'active' : ''}`;
            div.innerHTML = `<div style="color:${carData[name].color}">${name}</div><div style="font-size:10px">${unlockedCars.includes(name) ? 'OWNED' : '$'+carData[name].price}</div>`;
            div.onclick = () => {
                if(unlockedCars.includes(name)) { currentCar = name; }
                else if(credits >= carData[name].price) {
                    credits -= carData[name].price; unlockedCars.push(name); currentCar = name;
                }
                localStorage.setItem('nitroCr', credits); localStorage.setItem('nitroCars', JSON.stringify(unlockedCars));
                localStorage.setItem('nitroActiveCar', currentCar); renderGarage();
            };
            list.appendChild(div);
        }
    }

    function drawCar(c, x, y, name, color, angle = 0) {
        const d = carData[name] || carData['Specter'];
        c.save();
        c.translate(x + d.w/2, y + d.h/2);
        c.rotate(angle);
        c.shadowBlur = 15; c.shadowColor = color;
        c.strokeStyle = color; c.lineWidth = 3;
        c.strokeRect(-d.w/2, -d.h/2, d.w, d.h);
        c.fillStyle = "#000"; c.fillRect(-d.w/2, -d.h/2, d.w, d.h);
        c.restore();
    }

    function startGame(mode, admin = false) {
        gameState = 'PLAY'; gameMode = mode;
        score = admin ? 10000 : 0; speed = 10; enemies = []; frames = 0;
        p1 = { x: 200, y: 580 };
        document.getElementById('hud').style.visibility = 'visible';
        openPanel('none'); // Hide all menus
        gameLoop();
    }

    function gameLoop() {
        if(gameState !== 'PLAY') return;
        frames++; score++; speed += 0.005;
        wantedLevel = gameMode === 'PURSUIT' ? Math.min(6, Math.floor(score/1800)) : 0;

        // Player movement & Tilt
        if(keys['ArrowLeft'] && p1.x > 40) { p1.x -= 8; tilt = -0.1; }
        else if(keys['ArrowRight'] && p1.x < 360) { p1.x += 8; tilt = 0.1; }
        else { tilt *= 0.9; }

        if(frames % 40 === 0) {
            let type = (wantedLevel >= 5) ? 'TANK' : (wantedLevel >= 3 ? 'SWAT' : 'POLICE');
            if(gameMode === 'NORMAL') type = 'CIV';
            enemies.push({ x: 60 + Math.floor(Math.random()*4)*85, y: -150, type });
        }

        enemies.forEach((e, i) => {
            e.y += (speed - 4);
            const ed = (e.type === 'TANK' ? {w:90, h:130, c:'#ffaa00'} : (e.type === 'SWAT' ? {w:70, h:110, c:'#fff'} : {w:40, h:80, c:'#ff0044'}));
            if(p1.x < e.x + ed.w && p1.x + 40 > e.x && p1.y < e.y + ed.h && p1.y + 80 > e.y) {
                gameState = 'MENU'; credits += Math.floor(score/10);
                localStorage.setItem('nitroCr', credits); openPanel('menu');
            }
            if(e.y > 800) enemies.splice(i, 1);
        });

        // DRAWING
        ctx.fillStyle = "#010103"; ctx.fillRect(0,0,440,750);
        
        // FOV Warp lines
        ctx.strokeStyle = "rgba(0, 242, 255, 0.1)";
        for(let i=0; i<10; i++) {
            let ly = (frames * speed + i * 100) % 800;
            ctx.beginPath(); ctx.moveTo(0, ly); ctx.lineTo(440, ly); ctx.stroke();
        }

        drawCar(ctx, p1.x, p1.y, currentCar, carData[currentCar].color, tilt);
        
        enemies.forEach(e => {
            const ed = (e.type === 'TANK' ? {w:90, h:130, c:'#ffaa00'} : (e.type === 'SWAT' ? {w:70, h:110, c:'#fff'} : {w:40, h:80, c:'#ff0044'}));
            ctx.strokeStyle = ed.c; ctx.strokeRect(e.x, e.y, ed.w, ed.h);
        });

        document.getElementById('speedDisp').innerText = Math.floor(speed * 15) + " MPH";
        document.getElementById('creditsDisp').innerText = credits;
        document.getElementById('wanted').innerHTML = 'â˜…'.repeat(wantedLevel).fontcolor(wantedLevel >= 6 ? '#ffaa00' : '#ff0044');
        requestAnimationFrame(gameLoop);
    }

    // Showroom logic
    let sAngle = 0;
    function showroomLoop() {
        if(document.getElementById('garage-ui').classList.contains('hidden')) {
            requestAnimationFrame(showroomLoop);
            return;
        }
        sctx.clearRect(0,0,150,250);
        sAngle += 0.02;
        drawCar(sctx, 50, 80, currentCar, carData[currentCar].color, sAngle);
        requestAnimationFrame(showroomLoop);
    }

    function updateUI() { document.getElementById('wallet').innerText = credits; }
    updateUI();
    showroomLoop();
</script>
</body>
</html>
